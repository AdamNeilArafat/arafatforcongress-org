<!DOCTYPE html>
<html lang="en">
<head>
  <base href="/">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸŒ² Evergreen Pact â€” Sign & Verify</title>
  <meta name="description" content="Sign the Evergreen Pact. Candidates must double-confirm to prevent mistakes. Counts update fast." />
  <meta name="theme-color" content="#0d3b66" />

  <!-- Open Graph / Twitter -->
  <meta property="og:title" content="Evergreen Pact â€” Sign & Verify" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="assets/evergreen-tree.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Evergreen Pact â€” Sign & Verify" />
  <meta name="twitter:description" content="Triage, then reform. Steps that lower costs and restore checks and balances." />

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{ --primary:#0d3b66; --ink:#1b2634; --soft:#f6f9fc; --ok:#198754; --bad:#c1121f; --flash:#fff3cd; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--soft);color:var(--ink)}
    a{color:var(--primary);text-decoration:none}
    a:hover{text-decoration:underline}
    .navbar .nav-link{position:relative;padding:.25rem .5rem;font-weight:600;color:#122133}
    .navbar .nav-link::after{content:"";position:absolute;left:0;bottom:-4px;height:2px;width:0;background:currentColor;border-radius:2px;transition:width .18s}
    .navbar .nav-link:hover::after,.navbar .nav-link.active::after{width:100%}
    .hero{position:relative;background:#0b3157;color:#fff}
    .hero::before{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.35))}
    .hero .container{position:relative;z-index:1}
    .hero h1{font-weight:900;letter-spacing:.3px;text-shadow:0 2px 10px rgba(0,0,0,.4)}
    .btn-pill{border-radius:999px;padding:.55rem 1rem}
    .btn-icon i{margin-right:.5rem}
    .sig-card{background:#ffffff;color:#0b2847;border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:1rem;box-shadow:0 8px 18px rgba(0,0,0,.08)}
    .sig-card h2{font-size:1.25rem;margin:0 0 .25rem 0;letter-spacing:.2px}
    .sig-count{font-weight:800;line-height:1;margin:0}
    .sig-count .num{font-size:2.2rem}
    .sig-count .lbl{font-size:.8rem;opacity:.85}
    .sig-form .form-control{padding:.475rem .6rem}
    .sig-form .btn{padding:.5rem .8rem;font-weight:700}
    .sig-hint{font-size:.85rem;opacity:.95;min-height:1.2em}
    .toast-fixed{position:fixed;bottom:20px;right:20px;background:var(--ok);color:#fff;padding:10px 14px;border-radius:6px;z-index:9999;opacity:.95}
  </style>
  <link rel="stylesheet" href="/assets/site.css">
  <script defer src="/assets/site.js"></script>
</head>
<body>
<header class="site-header">
  <nav class="container">
    <a class="brand" href="/">Adam Neil Arafat for Congress â€“ WA-10</a>
    <ul class="nav">
      <li><a href="/issues.html">Issues</a></li>
      <li><a href="/contrast.html">Contrast</a></li>
      <li><a href="/Bills/Bills.html">Evergreen Pact</a></li>
      <li><a href="/contact.html">Contact</a></li>
      <li class="social"><a href="https://www.reddit.com" rel="me" aria-label="Reddit">Reddit</a></li>
      <li class="social"><a href="https://bsky.app" rel="me" aria-label="Bluesky">Bluesky</a></li>
      <li class="social"><a href="https://www.tiktok.com" rel="me" aria-label="TikTok">TikTok</a></li>
    </ul>
  </nav>
</header>

<!-- NAV -->


<!-- HERO -->




<!-- Bootstrap bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
(() => {
  // === CONFIG ===
  const API = "https://script.google.com/macros/s/AKfycbyHPZAWXfICEXJI6ipXLXF5cAh5gQe3U_616AV2y_XROk0vjex_fYG9MmL9aI9TMcgA/exec";

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
  const byId = (id) => document.getElementById(id);

  // Autofill handling
  function markValidity(input) {
    const optionalEmpty = !input.required && !input.value;
    const valid = optionalEmpty ? true : input.checkValidity();
    input.classList.remove("is-valid","is-invalid");
    if (!input.form.classList.contains("was-validated")) {
      if (input.value) input.classList.add(valid ? "is-valid" : "is-invalid");
    } else {
      input.classList.add(valid ? "is-valid" : "is-invalid");
    }
    return valid;
  }
  function validateAllInputs(form) { $$("input,textarea,select", form).forEach(markValidity); }
  function kickAutofill(form) { [120, 350, 800, 1400, 2200].forEach(ms => setTimeout(() => validateAllInputs(form), ms)); }
  function clearValidation(form) {
    form.classList.remove("was-validated");
    $$("input,textarea,select", form).forEach(i => i.classList.remove("is-valid","is-invalid"));
  }

  function setMsg(el, text, ok = true) {
    if (!el) return;
    el.textContent = text || "";
    el.classList.remove("text-danger","text-muted","text-success");
    el.classList.add(ok ? "text-success" : "text-danger");
  }
  function toggleBtn(btn, on) {
    if (!btn) return;
    btn.disabled = !on;
    btn.setAttribute("aria-busy", on ? "false" : "true");
    btn.classList.toggle("disabled", !on);
  }
  function formToJSON(form) {
    const data = {};
    $$("input,select,textarea", form).forEach((f) => {
      const key = f.name || f.id;
      if (!key) return;
      if (f.type === "checkbox") data[key] = String(f.checked);
      else data[key] = f.value.trim();
    });
    return data;
  }
  function toFormBody(obj) {
    const p = new URLSearchParams();
    Object.entries(obj).forEach(([k,v]) => p.append(k, v == null ? "" : String(v)));
    return p;
  }
  async function postForm(url, payload) {
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"},
      body: toFormBody(payload),
      redirect: "follow",
      mode: "cors"
    });
    let data = null;
    try { data = await res.json(); } catch (err) {}
    const ok = res.ok && data && data.ok;
    return { ok, status: res.status, data };
  }

  async function loadCounts() {
    try {
      const res = await fetch(API, { cache: "no-cache" });
      if (!res.ok) throw new Error('network');
      const data = await res.json();
      if (data.candidateCount != null) setCount('candidateCount', data.candidateCount);
      if (data.voterCount != null) setCount('voterCount', data.voterCount);
    } catch (err) {
      console.error('Failed to load counts', err);
      setCount('candidateCount', 0);
      setCount('voterCount', 0);
    }
  }
  function setCount(elId, value) {
    const el = byId(elId);
    if (!el) return;
    el.textContent = String(value);
    el.classList.add("flash");
    setTimeout(()=>el.classList.remove("flash"), 600);
  }
  function ensureAttrs(el, {name, autocomplete}) {
    if (!el) return;
    if (name && !el.name) el.name = name;
    if (autocomplete && !el.getAttribute("autocomplete")) el.setAttribute("autocomplete", autocomplete);
  }

  function wireSignatureForm({ formId, type, msgElId, fieldMap }) {
    const form = byId(formId);
    if (!form) return;
    const msgEl = byId(msgElId);
    const btn = $("button[type=submit]", form);

    // Ensure expected attrs (helps autofill)
    for (const meta of Object.values(fieldMap)) ensureAttrs(byId(meta.id), meta);

    // Live validation
    $$("input,textarea,select", form).forEach((inp) => {
      ["input","change","blur"].forEach(evt =>
        inp.addEventListener(evt, () => markValidity(inp), { passive: true })
      );
    });

    kickAutofill(form);
    window.addEventListener("pageshow", () => kickAutofill(form));

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      form.classList.add("was-validated");
      let allValid = true;
      $$("input,textarea,select", form).forEach((i)=>{ if (!markValidity(i)) allValid = false; });
      if (!allValid) {
        setMsg(msgEl, "Please fix the highlighted fields.", false);
        return;
      }

      const base = formToJSON(form);
      const email = (base[fieldMap.email.id] || "").toLowerCase();
      const candidateConfirmed = fieldMap.confirm
        ? (base[fieldMap.confirm.id] === "true" ? "true" : "false")
        : "false";

      if (type === "candidate" && candidateConfirmed !== "true") {
        setMsg(msgEl, "You must confirm you are a candidate.", false);
        return;
      }

      const payload = {
        // Exact sheet headers
        timestamp: new Date().toISOString(),
        type,
        email,

        ip: "", // let backend fill if desired
        city: base[fieldMap.city.id] || "",
        state: base[fieldMap.state.id] || "",
        userAgent: navigator.userAgent || "",
        firstName: base[fieldMap.first.id] || "",
        lastName: base[fieldMap.last.id] || "",
        candidateConfirmed
      };

      toggleBtn(btn, false);
      setMsg(msgEl, "Submittingâ€¦", true);

      try {
        const { ok, data } = await postForm(API, payload);
        if (!ok) {
          setMsg(msgEl, "Submit error. Please try again.", false);
          return;
        }

        if (data.duplicate) {
          setMsg(msgEl, "You already signed.", true);
        } else {
          setMsg(msgEl, "Thank you! Your signature was recorded.", true);
        }

        if (data.candidateCount != null) setCount('candidateCount', data.candidateCount);
        if (data.voterCount != null) setCount('voterCount', data.voterCount);

        form.reset();
        clearValidation(form);
        kickAutofill(form);
        loadCounts();
      } catch (err) {
        console.error(err);
        setMsg(msgEl, "Sorryâ€”could not submit. Please try again in a moment.", false);
      } finally {
        toggleBtn(btn, true);
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const y = document.getElementById("year"); if (y) y.textContent = new Date().getFullYear();

    loadCounts();

    wireSignatureForm({
      formId: "candidateForm",
      type: "candidate",
      msgElId: "candidateMsg",
      fieldMap: {
        first:  { id: "candidateFirst", name: "candidateFirst", autocomplete: "given-name" },
        last:   { id: "candidateLast",  name: "candidateLast",  autocomplete: "family-name" },
        email:  { id: "candidateEmail", name: "candidateEmail", autocomplete: "email" },
        city:   { id: "candidateCity",  name: "candidateCity",  autocomplete: "address-level2" },
        state:  { id: "candidateState", name: "candidateState", autocomplete: "address-level1" },
        confirm:{ id: "candidateConfirm", name:"candidateConfirm" }
      }
    });

    wireSignatureForm({
      formId: "voterForm",
      type: "voter",
      msgElId: "voterMsg",
      fieldMap: {
        first:  { id: "voterFirst", name: "voterFirst", autocomplete: "given-name" },
        last:   { id: "voterLast",  name: "voterLast",  autocomplete: "family-name" },
        email:  { id: "voterEmail", name: "voterEmail", autocomplete: "email" },
        city:   { id: "voterCity",  name: "voterCity",  autocomplete: "address-level2" },
        state:  { id: "voterState", name: "voterState", autocomplete: "address-level1" }
      }
    });
  });
})();
</script>
<footer class="site-footer">
  <div class="container">
    <p>Paid for by Adam Neil Arafat for Congress</p>
    <nav class="foot-nav">
      <a href="/about.html">About</a>
      <a href="/issues.html">Issues</a>
      <a href="/contrast.html">Contrast</a>
      <a href="/Bills/Bills.html">Evergreen Pact</a>
      <a href="/contact.html">Contact</a>
    </nav>
    <p class="small">Power People. Not PACs.</p>
  </div>
</footer>
</body>
</html>
