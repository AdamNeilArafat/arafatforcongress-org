<!DOCTYPE html>
<html lang="en">
<head>
  <base href="/">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üå≤ Evergreen Pact ‚Äî Sign & Verify</title>
  <meta name="description" content="Sign the Evergreen Pact. Candidates must double-confirm to prevent mistakes. Counts update fast." />
  <meta name="theme-color" content="#0d3b66" />

  <!-- Open Graph / Twitter -->
  <meta property="og:title" content="Evergreen Pact ‚Äî Sign & Verify" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="assets/evergreen-tree.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Evergreen Pact ‚Äî Sign & Verify" />
  <meta name="twitter:description" content="Triage, then reform. Steps that lower costs and restore checks and balances." />

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{ --primary:#0d3b66; --ink:#1b2634; --soft:#f6f9fc; --ok:#198754; --bad:#c1121f; --flash:#fff3cd; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--soft);color:var(--ink)}
    a{color:var(--primary);text-decoration:none}
    a:hover{text-decoration:underline}
    .navbar .nav-link{position:relative;padding:.25rem .5rem;font-weight:600;color:#122133}
    .navbar .nav-link::after{content:"";position:absolute;left:0;bottom:-4px;height:2px;width:0;background:currentColor;border-radius:2px;transition:width .18s}
    .navbar .nav-link:hover::after,.navbar .nav-link.active::after{width:100%}
    .hero{position:relative;background:#0b3157;color:#fff}
    .hero::before{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.35))}
    .hero .container{position:relative;z-index:1}
    .hero h1{font-weight:900;letter-spacing:.3px;text-shadow:0 2px 10px rgba(0,0,0,.4)}
    .btn-pill{border-radius:999px;padding:.55rem 1rem}
    .btn-icon i{margin-right:.5rem}
    .sig-card{background:#ffffff;color:#0b2847;border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:1rem;box-shadow:0 8px 18px rgba(0,0,0,.08)}
    .sig-card h2{font-size:1.25rem;margin:0 0 .25rem 0;letter-spacing:.2px}
    .sig-count{font-weight:800;line-height:1;margin:0}
    .sig-count .num{font-size:2.2rem}
    .sig-count .lbl{font-size:.8rem;opacity:.85}
    .sig-form .form-control{padding:.475rem .6rem}
    .sig-form .btn{padding:.5rem .8rem;font-weight:700}
    .sig-hint{font-size:.85rem;opacity:.95;min-height:1.2em}
    .toast-fixed{position:fixed;bottom:20px;right:20px;background:var(--ok);color:#fff;padding:10px 14px;border-radius:6px;z-index:9999;opacity:.95}
  </style>
</head>
<body>

<!-- NAV -->
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top" aria-label="Main">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">Adam Neil Arafat for Congress - WA-10</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav ms-auto align-items-lg-center">
        <li class="nav-item"><a class="nav-link active" href="/Bills/Bills.html" aria-current="page"><i class="fa-solid fa-tree me-1 text-success" aria-hidden="true"></i>Evergreen Pact</a></li>
        <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- HERO -->
<header class="py-5 hero">
  <div class="container text-center">
    <h1 class="display-5 mb-2">üå≤ The Evergreen Pact ‚Äî Sign & Verify</h1>
    <p class="lead mb-3">Each step helps working people without raising their taxes. Each step adds checks on executive power.</p>

    <div class="row justify-content-center g-3 mb-4 mt-4">
      <!-- Candidate -->
      <div class="col-md-5">
        <div class="sig-card text-dark">
          <h2 class="fw-bold">‚úçÔ∏è Candidate Signatures</h2>
          <p class="sig-count mb-3">
            <span class="num text-success" id="candidateCount">0</span>
            <span class="lbl d-block">total signed</span>
          </p>
          <form id="candidateForm" class="needs-validation sig-form" novalidate>
            <div class="row g-2">
              <div class="col-6">
                <label class="visually-hidden" for="candidateFirst">First name</label>
                <input type="text" class="form-control form-control-sm" id="candidateFirst" name="candidateFirst" placeholder="First name" autocomplete="given-name" required>
                <div class="invalid-feedback">First name required.</div>
              </div>
              <div class="col-6">
                <label class="visually-hidden" for="candidateLast">Last name</label>
                <input type="text" class="form-control form-control-sm" id="candidateLast" name="candidateLast" placeholder="Last name" autocomplete="family-name" required>
                <div class="invalid-feedback">Last name required.</div>
              </div>
            </div>

            <label class="visually-hidden" for="candidateEmail">Campaign email</label>
            <input type="email" class="form-control form-control-sm mt-2" id="candidateEmail" name="candidateEmail" placeholder="name@campaign.org" autocomplete="email" required>
            <div class="invalid-feedback">Valid email required.</div>

            <div class="row g-2 mt-2">
              <div class="col-7">
                <label class="visually-hidden" for="candidateCity">City (optional)</label>
                <input type="text" class="form-control form-control-sm" id="candidateCity" name="candidateCity" placeholder="City (optional)" autocomplete="address-level2">
              </div>
              <div class="col-5">
                <label class="visually-hidden" for="candidateState">State (optional)</label>
                <input type="text" class="form-control form-control-sm" id="candidateState" name="candidateState" placeholder="State (optional)" autocomplete="address-level1">
              </div>
            </div>

            <div class="form-check text-start mt-2">
              <input class="form-check-input" type="checkbox" id="candidateConfirm" name="candidateConfirm" required>
              <label class="form-check-label small" for="candidateConfirm">
                I confirm I am signing as a candidate.
              </label>
              <div class="invalid-feedback">You must confirm to continue.</div>
            </div>

            <button type="submit" class="btn btn-success w-100 mt-2">Sign as Candidate</button>
            <div id="candidateMsg" class="sig-hint mt-2" aria-live="polite"></div>
          </form>
        </div>
      </div>

      <!-- Voter -->
      <div class="col-md-5">
        <div class="sig-card text-dark">
          <h2 class="fw-bold">üó≥Ô∏è Voter Signatures</h2>
          <p class="sig-count mb-3">
            <span class="num text-primary" id="voterCount">0</span>
            <span class="lbl d-block">total signed</span>
          </p>
          <form id="voterForm" class="needs-validation sig-form" novalidate>
            <div class="row g-2">
              <div class="col-6">
                <label class="visually-hidden" for="voterFirst">First name</label>
                <input type="text" class="form-control form-control-sm" id="voterFirst" name="voterFirst" placeholder="First name" autocomplete="given-name" required>
                <div class="invalid-feedback">First name required.</div>
              </div>
              <div class="col-6">
                <label class="visually-hidden" for="voterLast">Last name</label>
                <input type="text" class="form-control form-control-sm" id="voterLast" name="voterLast" placeholder="Last name" autocomplete="family-name" required>
                <div class="invalid-feedback">Last name required.</div>
              </div>
            </div>

            <label class="visually-hidden" for="voterEmail">Email</label>
            <input type="email" class="form-control form-control-sm mt-2" id="voterEmail" name="voterEmail" placeholder="name@email.com" autocomplete="email" required>
            <div class="invalid-feedback">Valid email required.</div>

            <div class="row g-2 mt-2">
              <div class="col-7">
                <label class="visually-hidden" for="voterCity">City (optional)</label>
                <input type="text" class="form-control form-control-sm" id="voterCity" name="voterCity" placeholder="City (optional)" autocomplete="address-level2">
              </div>
              <div class="col-5">
                <label class="visually-hidden" for="voterState">State (optional)</label>
                <input type="text" class="form-control form-control-sm" id="voterState" name="voterState" placeholder="State (optional)" autocomplete="address-level1">
              </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-2">Sign as Voter</button>
            <div id="voterMsg" class="sig-hint mt-2" aria-live="polite"></div>
          </form>
        </div>
      </div>
    </div>
  </div>
</header>

<footer class="mt-auto">
  <div class="container text-center small py-3">
    &copy; <span id="year"></span> Adam Neil Arafat for Congress ‚Äî WA-10
  </div>
</footer>

<!-- Bootstrap bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
(() => {
  // === CONFIG ===
  const API = "https://script.google.com/macros/s/AKfycbyHPZAWXfICEXJI6ipXLXF5cAh5gQe3U_616AV2y_XROk0vjex_fYG9MmL9aI9TMcgA/exec";

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
  const byId = (id) => document.getElementById(id);

  // Autofill handling
  function markValidity(input) {
    const optionalEmpty = !input.required && !input.value;
    const valid = optionalEmpty ? true : input.checkValidity();
    input.classList.remove("is-valid","is-invalid");
    if (!input.form.classList.contains("was-validated")) {
      if (input.value) input.classList.add(valid ? "is-valid" : "is-invalid");
    } else {
      input.classList.add(valid ? "is-valid" : "is-invalid");
    }
    return valid;
  }
  function validateAllInputs(form) { $$("input,textarea,select", form).forEach(markValidity); }
  function kickAutofill(form) { [120, 350, 800, 1400, 2200].forEach(ms => setTimeout(() => validateAllInputs(form), ms)); }
  function clearValidation(form) {
    form.classList.remove("was-validated");
    $$("input,textarea,select", form).forEach(i => i.classList.remove("is-valid","is-invalid"));
  }

  function setMsg(el, text, ok = true) {
    if (!el) return;
    el.textContent = text || "";
    el.classList.remove("text-danger","text-muted","text-success");
    el.classList.add(ok ? "text-success" : "text-danger");
  }
  function toggleBtn(btn, on) {
    if (!btn) return;
    btn.disabled = !on;
    btn.setAttribute("aria-busy", on ? "false" : "true");
    btn.classList.toggle("disabled", !on);
  }
  function formToJSON(form) {
    const data = {};
    $$("input,select,textarea", form).forEach((f) => {
      const key = f.name || f.id;
      if (!key) return;
      if (f.type === "checkbox") data[key] = String(f.checked);
      else data[key] = f.value.trim();
    });
    return data;
  }
  function toFormBody(obj) {
    const p = new URLSearchParams();
    Object.entries(obj).forEach(([k,v]) => p.append(k, v == null ? "" : String(v)));
    return p;
  }
  async function postForm(url, payload) {
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"},
      body: toFormBody(payload),
      redirect: "follow",
      mode: "cors"
    });
    const ok = res.status >= 200 && res.status < 300;
    return { ok, status: res.status };
  }

  async function loadCounts() {
    const candEl = byId('candidateCount');
    const voterEl = byId('voterCount');
    if (candEl) candEl.textContent = '';
    if (voterEl) voterEl.textContent = '';
    try {
      const res = await fetch(API);
      if (!res.ok) throw new Error('network');
      const data = await res.json();
      if (candEl && data.candidateCount != null) candEl.textContent = data.candidateCount;
      if (voterEl && data.voterCount != null) voterEl.textContent = data.voterCount;
    } catch (err) {
      console.error('Failed to load counts', err);
    }
  }
  function bumpCount(elId) {
    const el = byId(elId);
    if (!el) return;
    const cur = parseInt((el.textContent || "").replace(/[^0-9]/g,""),10);
    const next = Number.isFinite(cur) ? cur + 1 : 1;
    el.textContent = String(next);
    el.classList.add("flash");
    setTimeout(()=>el.classList.remove("flash"), 600);
  }
  function ensureAttrs(el, {name, autocomplete}) {
    if (!el) return;
    if (name && !el.name) el.name = name;
    if (autocomplete && !el.getAttribute("autocomplete")) el.setAttribute("autocomplete", autocomplete);
  }

  function wireSignatureForm({ formId, type, countElId, msgElId, fieldMap }) {
    const form = byId(formId);
    if (!form) return;
    const msgEl = byId(msgElId);
    const btn = $("button[type=submit]", form);

    // Ensure expected attrs (helps autofill)
    for (const meta of Object.values(fieldMap)) ensureAttrs(byId(meta.id), meta);

    // Live validation
    $$("input,textarea,select", form).forEach((inp) => {
      ["input","change","blur"].forEach(evt =>
        inp.addEventListener(evt, () => markValidity(inp), { passive: true })
      );
    });

    kickAutofill(form);
    window.addEventListener("pageshow", () => kickAutofill(form));

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      form.classList.add("was-validated");
      let allValid = true;
      $$("input,textarea,select", form).forEach((i)=>{ if (!markValidity(i)) allValid = false; });
      if (!allValid) {
        setMsg(msgEl, "Please fix the highlighted fields.", false);
        return;
      }

      const base = formToJSON(form);
      const email = (base[fieldMap.email.id] || "").toLowerCase();
      // Backend computes SHA-256 email hash in hex for duplicate checks
      const candidate_confirmed = type === "candidate"
        ? ((base[fieldMap.confirm.id] === "true") ? "true" : "false")
        : "false";

      if (type === "candidate" && candidate_confirmed !== "true") {
        setMsg(msgEl, "You must confirm you are a candidate.", false);
        return;
      }

      const payload = {
        // Exact sheet headers
        timestamp: new Date().toISOString(),
        type,
        email,
        ip: "", // let backend fill if desired
        city: base[fieldMap.city.id] || "",
        state: base[fieldMap.state.id] || "",
        user_agent: navigator.userAgent || "",
        first_name: base[fieldMap.first.id] || "",
        last_name: base[fieldMap.last.id] || "",
        candidate_confirmed
      };

      toggleBtn(btn, false);
      setMsg(msgEl, "Submitting‚Ä¶", true);

      try {
        const { ok } = await postForm(API, payload);
        if (!ok) { setMsg(msgEl, "Submit error. Please try again.", false); return; }
        setMsg(msgEl, "Thank you! Your signature was recorded.", true);
        bumpCount(countElId);
        form.reset();
        clearValidation(form);
        kickAutofill(form);
      } catch (err) {
        console.error(err);
        setMsg(msgEl, "Sorry‚Äîcould not submit. Please try again in a moment.", false);
      } finally {
        toggleBtn(btn, true);
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const y = document.getElementById("year"); if (y) y.textContent = new Date().getFullYear();

    loadCounts();

    wireSignatureForm({
      formId: "candidateForm",
      type: "candidate",
      countElId: "candidateCount",
      msgElId: "candidateMsg",
      fieldMap: {
        first:  { id: "candidateFirst", name: "candidateFirst", autocomplete: "given-name" },
        last:   { id: "candidateLast",  name: "candidateLast",  autocomplete: "family-name" },
        email:  { id: "candidateEmail", name: "candidateEmail", autocomplete: "email" },
        city:   { id: "candidateCity",  name: "candidateCity",  autocomplete: "address-level2" },
        state:  { id: "candidateState", name: "candidateState", autocomplete: "address-level1" },
        confirm:{ id: "candidateConfirm", name:"candidateConfirm" }
      }
    });

    wireSignatureForm({
      formId: "voterForm",
      type: "voter",
      countElId: "voterCount",
      msgElId: "voterMsg",
      fieldMap: {
        first:  { id: "voterFirst", name: "voterFirst", autocomplete: "given-name" },
        last:   { id: "voterLast",  name: "voterLast",  autocomplete: "family-name" },
        email:  { id: "voterEmail", name: "voterEmail", autocomplete: "email" },
        city:   { id: "voterCity",  name: "voterCity",  autocomplete: "address-level2" },
        state:  { id: "voterState", name: "voterState", autocomplete: "address-level1" }
      }
    });
  });
})();
</script>
</body>
</html>
