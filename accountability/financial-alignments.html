<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Financial Alignments & Interests — Adam Neil Arafat for Congress</title>
  <meta name="description" content="Data-driven donor analysis: PAC vs small donors, in-district vs out-district, industry breakdowns, and vote alignment indicators."/>
  <meta name="theme-color" content="#0d3b66"/>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{
      --ink:#122133; --muted:#5b6b7c; --soft:#f6f9fc; --danger:#c1121f; --ok:#0b6e4f; --brand:#0d3b66;
      --card:#fff; --ring:rgba(13,59,102,.12); --ring-strong:rgba(13,59,102,.22);
    }
    html,body{background:var(--soft); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--brand); text-decoration:none} a:hover{text-decoration:underline}
    .navbar .nav-link{position:relative; padding:.25rem .5rem; font-weight:600; color:#1b2a3a}
    .navbar .nav-link::after{content:""; position:absolute; left:0; bottom:-4px; height:2px; width:0; background:currentColor; border-radius:2px; transition:width .18s}
    .navbar .nav-link:hover::after,.navbar .nav-link.active::after{width:100%}
    .hero{background:linear-gradient(180deg,#0d3b66,#0b3157); color:#fff; padding:2rem 0}
    .hero h1{font-weight:900; letter-spacing:.3px}
    .cardish{background:var(--card); border:1px solid var(--ring); border-radius:14px; box-shadow:0 4px 18px rgba(13,59,102,.06)}
    .metric{font-weight:900; font-size:1.4rem}
    .mini{color:var(--muted); font-size:.9rem}
    .chart-box{height:300px; background:#eef4fa; border:1px dashed #b7c6d8; border-radius:12px}
    .table thead th{background:#f4f7fb}
    .badge-chip{display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .45rem; border-radius:999px; border:1px solid var(--ring-strong); font-weight:700; font-size:.75rem}
    .badge-chip i{font-size:.85rem}
    .chip-danger{background:#ffecec; border-color:#ffd0d0; color:#8d0a0a}
    .chip-warn{background:#fff8e6; border-color:#ffe5a3; color:#7a5200}
    .chip-ok{background:#e9f7ef; border-color:#cfe9d8; color:#0b6e4f}
    footer{background:#0d3b66; color:#fff; padding:1.25rem 0; margin-top:2rem}
    .avatar{width:28px;height:28px;object-fit:cover;border-radius:50%;border:1px solid var(--ring-strong)}
  </style>
</head>
<body>

<!-- NAV -->
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top" aria-label="Main">
  <div class="container">
    <a class="navbar-brand fw-bold" href="./index.html">Adam Neil Arafat for Congress - WA-10</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav ms-auto align-items-lg-center">
        <li class="nav-item"><a class="nav-link" href="./index.html">Wall of Shame</a></li>
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="./financial-alignments.html">Financial Alignments</a></li>
        <li class="nav-item"><a class="nav-link" href="./badges.html">Badges &amp; Awards</a></li>
        <li class="nav-item"><a class="nav-link" href="./digging-into-the-issues.html">Issues</a></li>
        <li class="nav-item"><a class="nav-link" href="./contrast.html">Record &amp; Contrast</a></li>
        <li class="nav-item"><a class="nav-link" href="./contact.html">Contact</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- HERO -->
<header class="hero">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div>
        <h1 class="mb-1">Financial Alignments &amp; Interests</h1>
        <p class="mb-0">PAC vs small donors, in‑district vs out‑district, industries, and vote alignment — with clear badge triggers.</p>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-light btn-sm" href="./index.html"><i class="fa-solid fa-arrow-left-long me-1"></i>Back to Wall</a>
        <a class="btn btn-danger btn-sm" href="./badges.html"><i class="fa-solid fa-award me-1"></i>Badge Definitions</a>
      </div>
    </div>
  </div>
</header>

<main class="container my-4">
  <!-- Filters -->
  <div class="cardish p-3 mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label for="fa-member" class="form-label">Member</label>
        <input type="search" id="fa-member" class="form-control" placeholder="Search name, state, or seat (e.g., WA-10)"/>
      </div>
      <div class="col-md-3">
        <label for="fa-chamber" class="form-label">Chamber</label>
        <select id="fa-chamber" class="form-select">
          <option value="">All</option>
          <option value="house">House</option>
          <option value="senate">Senate</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="fa-industry" class="form-label">Industry Focus</label>
        <select id="fa-industry" class="form-select">
          <option value="">All industries</option>
          <option value="pharma">Pharma</option>
          <option value="defense">Defense</option>
          <option value="finance">Finance</option>
          <option value="oil">Oil &amp; Gas</option>
          <option value="aipac">AIPAC/Israel</option>
          <option value="tech">Tech</option>
        </select>
      </div>
      <div class="col-md-2 d-grid">
        <button id="fa-reset" class="btn btn-outline-secondary">Reset</button>
      </div>
    </div>
  </div>

  <!-- Metrics row -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="cardish p-3">
        <div class="mini">PAC vs Small Donors</div>
        <div class="metric" id="m-pac-small">—</div>
        <div class="mini">Flagged if PAC &gt;= threshold</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="cardish p-3">
        <div class="mini">In‑District vs Out‑District</div>
        <div class="metric" id="m-geo">—</div>
        <div class="mini">Flagged if out &gt; in</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="cardish p-3">
        <div class="mini">Top Industry</div>
        <div class="metric" id="m-top-industry">—</div>
        <div class="mini">Badge if one industry dominates</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="cardish p-3">
        <div class="mini">Vote Alignment Index</div>
        <div class="metric" id="m-vote-align">—</div>
        <div class="mini">Badge if ≥ 90% donor-aligned</div>
      </div>
    </div>
  </div>

  <!-- Charts row (placeholders) -->
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="cardish p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-0">PAC vs Small Donors</h2>
          <a href="./badges.html#thresholds" class="small">See thresholds</a>
        </div>
        <div class="chart-box d-flex align-items-center justify-content-center">
          <span class="text-muted">Chart placeholder (PAC % vs Small %)</span>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="cardish p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-0">In‑District vs Out‑District</h2>
          <a href="./badges.html#thresholds" class="small">See thresholds</a>
        </div>
        <div class="chart-box d-flex align-items-center justify-content-center">
          <span class="text-muted">Chart placeholder (In vs Out by $)</span>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="cardish p-3 mt-3">
        <h2 class="h6 mb-2">Industry Breakdown</h2>
        <div class="chart-box d-flex align-items-center justify-content-center">
          <span class="text-muted">Chart placeholder (Pharma/Defense/Finance/Oil/AIPAC/etc.)</span>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="cardish p-3 mt-3">
        <h2 class="h6 mb-2">Donor Geography</h2>
        <div class="chart-box d-flex align-items-center justify-content-center">
          <span class="text-muted">Map placeholder (clusters/heatmap)</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Data table -->
  <div class="cardish p-3 mt-4">
    <div class="d-flex align-items-center justify-content-between">
      <h2 class="h6 mb-0">Detail Table</h2>
      <span class="small text-muted">Each row indicates which badges were triggered</span>
    </div>
    <div class="table-responsive mt-2">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Member</th>
            <th>Seat</th>
            <th>PAC %</th>
            <th>Small %</th>
            <th>In vs Out</th>
            <th>Top Industry</th>
            <th>Vote Align</th>
            <th>Badges</th>
          </tr>
        </thead>
        <tbody id="fa-table">
          <tr><td colspan="8" class="text-muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<footer>
  <div class="container text-center small">
    <p class="mb-1">Paid for by Adam Neil Arafat for Congress</p>
    <p class="mb-0">&copy; 2025 Adam Neil Arafat. All Rights Reserved.</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

<!-- Data wiring -->
<script>
(async function loadFinance(){
  const $ = (s, el=document)=>el.querySelector(s);
  const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));

  // Thresholds (tune here, matches your badge definitions page)
  const THRESH = {
    PAC_FLAG: 0.40,           // >= 40% PAC -> flag
    INDUSTRY_DOMINATE: 0.35,  // >= 35% single industry share -> flag
    ALIGN_HIGH: 0.90          // >= 90% donor-aligned votes -> flag
  };

  // Fetch helpers with graceful fallback
  async function getJSON(path, fallback={}) {
    try {
      const r = await fetch(path, {cache:'no-store'});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    } catch(e) {
      console.warn('Failed to load', path, e);
      return fallback;
    }
  }

  // Load all needed data
  const [members, donorsByMember, awardsByMember, voteAlignByMember] = await Promise.all([
    getJSON('data/members.json', {}),
    getJSON('data/donors-by-member.json', {}),
    getJSON('data/member-awards.json', {}),
    getJSON('data/vote-alignments.json', {})
  ]);

  // Lightweight normalizers
  function pct(n){ return Math.round((n||0)*100); }
  function money(n){ return '$' + (Math.round(n||0)).toLocaleString(); }

  function resolveMember(mid){
    // Expect members[mid] like {id,name,seat,state,chamber,party,photo}
    return (members && members[mid]) || null;
  }

  function topIndustry(d){
    // Accepts donor record with .industries object {industry_key: dollars}
    if(!d || !d.industries) return {key:'—', share:0};
    const entries = Object.entries(d.industries);
    if(!entries.length) return {key:'—', share:0};
    const total = entries.reduce((s, [,v])=>s+(v||0),0) || 1;
    entries.sort((a,b)=>(b[1]||0)-(a[1]||0));
    const [key, amt] = entries[0];
    return {key, share: (amt||0)/total};
  }

  // Badge builder from finance + awards + vote alignment
  function computeBadges(mid, dRec, aRec, vRec){
    const chips = [];

    // PAC vs small donors
    const pacPct = dRec?.pac_pct ?? 0;
    if(pacPct >= THRESH.PAC_FLAG){
      chips.push(['chip-danger','fa-hand-holding-dollar',`High PAC: ${pct(pacPct)}%`]);
    }else{
      chips.push(['chip-ok','fa-people-group',`Small donors: ${100-pct(pacPct)}%`]);
    }

    // Geography
    const in$ = dRec?.in_state_dollars || 0;
    const out$ = dRec?.out_state_dollars || 0;
    if(out$ > in$ * 1.05){ // small buffer to avoid jitter
      chips.push(['chip-warn','fa-route',`Out-of-state heavy (${money(out$)} vs ${money(in$)})`]);
    }else{
      chips.push(['chip-ok','fa-house-flag',`Local support (${money(in$)})`]);
    }

    // Industry dominance
    const ti = topIndustry(dRec);
    if(ti.key !== '—' && ti.share >= THRESH.INDUSTRY_DOMINATE){
      chips.push(['chip-danger','fa-industry','Dominant industry: '+ti.key]);
    }

    // Vote alignment with donors
    const align = vRec?.donor_alignment_index ?? 0; // 0..1
    if(align >= THRESH.ALIGN_HIGH){
      chips.push(['chip-danger','fa-scale-balanced',`Donor-aligned votes: ${pct(align)}%`]);
    }

    // Pipeline “awards” (pre-computed triggers)
    if(aRec && Array.isArray(aRec.badges)){
      aRec.badges.forEach(b=>{
        // Expect b like {key:'pharma-overweight', label:'Pharma Overweight'}
        chips.push(['chip-danger','fa-award', b.label || b.key]);
      });
    }

    return chips;
  }

  // Populate headline metrics using first available record
  (function setHeadline(){
    const mids = Object.keys(donorsByMember || {});
    if(!mids.length) return;
    const mid = mids[0];
    const d = donorsByMember[mid] || {};
    const va = voteAlignByMember[mid] || {};
    const ti = topIndustry(d);

    $('#m-pac-small').textContent = `${pct(d.pac_pct||0)}% PAC / ${100 - pct(d.pac_pct||0)}% small`;
    $('#m-geo').textContent = `${money(d.in_state_dollars||0)} in / ${money(d.out_state_dollars||0)} out`;
    $('#m-top-industry').textContent = ti.key==='—' ? '—' : `${ti.key} (${pct(ti.share)}%)`;
    $('#m-vote-align').textContent = va && typeof va.donor_alignment_index==='number'
      ? `${pct(va.donor_alignment_index)}%`
      : '—';
  })();

  // Build table rows with filters
  const tbody = $('#fa-table');
  function rowHTML(mid){
    const m = resolveMember(mid);
    const d = donorsByMember[mid] || {};
    const a = awardsByMember[mid] || null;
    const v = voteAlignByMember[mid] || null;
    const ti = topIndustry(d);

    const pacP = pct(d.pac_pct||0);
    const smlP = 100 - pacP;
    const in$ = d.in_state_dollars||0, out$ = d.out_state_dollars||0;

    const chips = computeBadges(mid, d, a, v).map(([cls, icon, label]) =>
      `<span class="badge-chip ${cls}" title="${label}"><i class="fa-solid ${icon}"></i>${label}</span>`
    ).join(' ');

    const name = m?.name || mid;
    const seat = m?.seat || (m?.state ? `${m.state}` : '—');
    const photo = m?.photo || m?.image || ''; // optional

    return `<tr data-mid="${mid}" data-name="${(name||'').toLowerCase()}" data-seat="${(seat||'').toLowerCase()}" data-state="${(m?.state||'').toLowerCase()}" data-chamber="${(m?.chamber||'').toLowerCase()}">
      <td>
        <div class="d-flex align-items-center gap-2">
          ${photo ? `<img class="avatar" src="${photo}" alt="${name} headshot" loading="lazy">` : `<span class="avatar d-inline-flex align-items-center justify-content-center bg-light"><i class="fa-solid fa-user"></i></span>`}
          <div>
            <div class="fw-bold">${name}</div>
            <div class="text-muted small">${m?.party ? m.party : ''}</div>
          </div>
        </div>
      </td>
      <td>${seat}</td>
      <td>${pacP}%</td>
      <td>${smlP}%</td>
      <td>${money(in$)} / ${money(out$)}</td>
      <td>${ti.key==='—' ? '—' : `${ti.key} (${pct(ti.share)}%)`}</td>
      <td>${v && typeof v.donor_alignment_index==='number' ? `${pct(v.donor_alignment_index)}%` : '—'}</td>
      <td style="min-width:280px">${chips}</td>
    </tr>`;
  }

  function rebuildTable(){
    const mids = Object.keys(donorsByMember || {});
    if(!mids.length){
      tbody.innerHTML = `<tr><td colspan="8" class="text-muted">No finance data found. Did you run the pipeline?</td></tr>`;
      return;
    }
    tbody.innerHTML = mids.map(rowHTML).join('');
  }

  rebuildTable();

  // Filters wiring
  const qInput = $('#fa-member');
  const chamberSel = $('#fa-chamber');
  const industrySel = $('#fa-industry');
  const resetBtn = $('#fa-reset');

  function passesIndustryFilter(mid, wanted){
    if(!wanted) return true;
    const d = donorsByMember[mid] || {};
    const inds = d.industries || {};
    // Accept keys like "pharma", "defense", etc. Case-insensitive includes
    const keys = Object.keys(inds).map(k=>k.toLowerCase());
    return keys.includes(wanted.toLowerCase());
  }

  function applyFilters(){
    const q = (qInput.value || '').trim().toLowerCase();
    const ch = (chamberSel.value || '').toLowerCase();
    const ind = (industrySel.value || '').toLowerCase();

    const rows = $$('#fa-table tr');
    rows.forEach(tr=>{
      const mid = tr.getAttribute('data-mid');
      const nm = tr.getAttribute('data-name') || '';
      const st = tr.getAttribute('data-state') || '';
      const seat = tr.getAttribute('data-seat') || '';
      const chamber = tr.getAttribute('data-chamber') || '';

      const textHit = !q || nm.includes(q) || st.includes(q) || seat.includes(q);
      const chamberHit = !ch || chamber === ch;
      const industryHit = passesIndustryFilter(mid, ind);

      tr.style.display = (textHit && chamberHit && industryHit) ? '' : 'none';
    });
  }

  qInput.addEventListener('input', applyFilters);
  chamberSel.addEventListener('change', applyFilters);
  industrySel.addEventListener('change', applyFilters);
  resetBtn.addEventListener('click', ()=>{
    qInput.value = '';
    chamberSel.value = '';
    industrySel.value = '';
    applyFilters();
  });

})();
</script>
</body>
</html>
