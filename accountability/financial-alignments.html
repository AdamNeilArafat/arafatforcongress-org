<!-- financial-alignments.html — FULL, DROP-IN PAGE (images use same local path; no fake Receipts/Votes tabs) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Financial Alignments & Interests — Adam Neil Arafat for Congress</title>
  <meta name="description" content="PAC vs small donors, in-district vs out-district, industry breakdowns, and vote alignment indicators."/>
  <meta name="theme-color" content="#0d3b66"/>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{ --ink:#122133; --muted:#5b6b7c; --soft:#f6f9fc; --danger:#c1121f; --ok:#0b6e4f; --brand:#0d3b66; --card:#fff; --ring:rgba(13,59,102,.12); --ring-strong:rgba(13,59,102,.22); }
    html,body{background:var(--soft); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--brand); text-decoration:none} a:hover{text-decoration:underline}
    .navbar .nav-link{position:relative; padding:.25rem .5rem; font-weight:600; color:#1b2a3a}
    .navbar .nav-link::after{content:""; position:absolute; left:0; bottom:-4px; height:2px; width:0; background:currentColor; border-radius:2px; transition:width .18s}
    .navbar .nav-link:hover::after,.navbar .nav-link.active::after{width:100%}

    .hero{background:linear-gradient(180deg,#0d3b66,#0b3157); color:#fff; padding:2rem 0}
    .hero h1{font-weight:900; letter-spacing:.3px}

    .cardish{background:var(--card); border:1px solid var(--ring); border-radius:14px; box-shadow:0 4px 18px rgba(13,59,102,.06)}
    .metric{font-weight:900; font-size:1.4rem}
    .mini{color:var(--muted); font-size:.9rem}

    .list-people{display:flex; flex-direction:column; gap:12px}
    .person{position:relative; border:1px solid var(--ring); border-radius:16px; overflow:hidden; background:#fff; box-shadow:0 6px 20px rgba(13,59,102,.06); cursor:pointer}
    .person .rowwrap{display:flex; gap:0}
    .thumb{width:140px; min-width:140px; background:#e9eef5; overflow:hidden}
    .thumb img{width:100%; height:100%; object-fit:cover; display:block; aspect-ratio:1/1}
    .pdata{flex:1; padding:.75rem .9rem}
    .name{font-weight:800; line-height:1.1; margin:0}
    .sub{color:var(--muted); font-size:.9rem}
    .chips{display:flex; flex-wrap:wrap; gap:.35rem; margin-top:.45rem}
    .chip{display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .55rem; border-radius:999px; border:1px solid var(--ring-strong); font-weight:700; font-size:.75rem}
    .chip i{font-size:.85rem}
    .chip-ok{background:#e9f7ef; border-color:#cfe9d8; color:#0b6e4f}
    .chip-warn{background:#fff8e6; border-color:#ffe5a3; color:#7a5200}
    .chip-danger{background:#ffecec; border-color:#ffd0d0; color:#8d0a0a}
    .actions{display:flex; gap:.4rem; flex-wrap:wrap; align-items:center}
    .person:focus-within, .person:hover{outline:2px solid rgba(13,59,102,.22); outline-offset:2px}

    .table thead th{background:#f4f7fb; white-space:nowrap; user-select:none; cursor:pointer}
    .table thead th[data-sort]:after{content:"  ↕"; color:#90a0b2; font-weight:400}
    .table thead th.sorted-asc:after{content:"  ↑"} .table thead th.sorted-desc:after{content:"  ↓"}
    .table td{vertical-align:middle}

    footer{background:#0d3b66; color:#fff; padding:1.25rem 0; margin-top:2rem}
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top" aria-label="Main">
  <div class="container">
    <a class="navbar-brand fw-bold" href="./index.html">Adam Neil Arafat for Congress - WA-10</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav ms-auto align-items-lg-center">
        <li class="nav-item"><a class="nav-link" href="./index.html">Wall of Shame</a></li>
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="./financial-alignments.html">Financial Alignments</a></li>
        <li class="nav-item"><a class="nav-link" href="./badges.html">Badges &amp; Awards</a></li>
        <li class="nav-item"><a class="nav-link" href="./digging-into-the-issues.html">Issues</a></li>
        <li class="nav-item"><a class="nav-link" href="./contrast.html">Record &amp; Contrast</a></li>
        <li class="nav-item"><a class="nav-link" href="./contact.html">Contact</a></li>
      </ul>
    </div>
  </div>
</nav>

<header class="hero">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div>
        <h1 class="mb-1">Financial Alignments &amp; Interests</h1>
        <p class="mb-0">Faces first. Each row shows PAC vs small donors, local vs out‑of‑district, top industry, and donor‑vote alignment.</p>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-light btn-sm" href="./index.html"><i class="fa-solid fa-arrow-left-long me-1"></i>Back to Wall</a>
        <a class="btn btn-danger btn-sm" href="./badges.html#thresholds"><i class="fa-solid fa-award me-1"></i>Badge Definitions</a>
      </div>
    </div>
  </div>
</header>

<main class="container my-4">
  <div class="cardish p-3 mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label for="fa-member" class="form-label">Search member</label>
        <input type="search" id="fa-member" class="form-control" placeholder="Name, state, or seat (e.g., WA-10)" autocomplete="off"/>
      </div>
      <div class="col-md-3">
        <label for="fa-chamber" class="form-label">Chamber</label>
        <select id="fa-chamber" class="form-select">
          <option value="">All</option>
          <option value="house">House</option>
          <option value="senate">Senate</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="fa-industry" class="form-label">Industry focus</label>
        <select id="fa-industry" class="form-select">
          <option value="">All industries</option>
          <option value="pharma">Pharma</option>
          <option value="defense">Defense</option>
          <option value="finance">Finance</option>
          <option value="oil">Oil &amp; Gas</option>
          <option value="aipac">AIPAC/Israel</option>
          <option value="tech">Tech</option>
        </select>
      </div>
      <div class="col-md-2 d-grid">
        <button id="fa-reset" class="btn btn-outline-secondary">Reset</button>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mt-3 align-items-center">
      <button id="btn-export" class="btn btn-sm btn-outline-dark"><i class="fa-solid fa-file-arrow-down me-1"></i>Export CSV</button>
      <span id="load-status" class="small text-muted" role="status" aria-live="polite">Loading…</span>
    </div>
  </div>

  <!-- Headline metrics reflect the visible set -->
  <div class="row g-3 mb-3">
    <div class="col-md-3"><div class="cardish p-3"><div class="mini">PAC vs Small Donors</div><div class="metric" id="m-pac-small">—</div><div class="mini">Flagged if PAC ≥ threshold</div></div></div>
    <div class="col-md-3"><div class="cardish p-3"><div class="mini">In-District vs Out-District</div><div class="metric" id="m-geo">—</div><div class="mini">Flagged if out &gt; in</div></div></div>
    <div class="col-md-3"><div class="cardish p-3"><div class="mini">Top Industry</div><div class="metric" id="m-top-industry">—</div><div class="mini">Badge if one industry dominates</div></div></div>
    <div class="col-md-3"><div class="cardish p-3"><div class="mini">Vote Alignment Index</div><div class="metric" id="m-vote-align">—</div><div class="mini">Badge if ≥ 90% donor-aligned</div></div></div>
  </div>

  <!-- (optional) chart placeholders left in for layout continuity -->
  <div class="row g-3 mb-3">
    <div class="col-lg-6"><div class="cardish p-3"><div class="d-flex justify-content-between align-items-center"><h2 class="h6 mb-0">PAC vs Small Donors</h2><a href="./badges.html#thresholds" class="small">See thresholds</a></div><div class="d-flex align-items-center justify-content-center" style="height:300px;background:#eef4fa;border:1px dashed #b7c6d8;border-radius:12px"><span class="text-muted">Chart placeholder</span></div></div></div>
    <div class="col-lg-6"><div class="cardish p-3"><div class="d-flex justify-content-between align-items-center"><h2 class="h6 mb-0">In-District vs Out-District</h2><a href="./badges.html#thresholds" class="small">See thresholds</a></div><div class="d-flex align-items-center justify-content-center" style="height:300px;background:#eef4fa;border:1px dashed #b7c6d8;border-radius:12px"><span class="text-muted">Chart placeholder</span></div></div></div>
  </div>

  <section aria-labelledby="listHeading" class="mt-3">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
      <h2 id="listHeading" class="h6 mb-0">Members — Face List</h2>
      <span class="small text-muted">Click a row for details. Filters above apply here.</span>
    </div>
    <div id="fa-list" class="list-people"><div class="text-muted">Loading…</div></div>
  </section>

  <details class="cardish p-3 mt-3">
    <summary class="small fw-semibold">Show data table (advanced)</summary>
    <div class="table-responsive mt-2">
      <table class="table table-sm align-middle" id="fa-table-el">
        <thead>
          <tr>
            <th data-sort="name">Member</th>
            <th data-sort="seat">Seat</th>
            <th class="text-nowrap" data-sort="pac">PAC %</th>
            <th class="text-nowrap" data-sort="small">Small %</th>
            <th class="text-nowrap" data-sort="geo">In vs Out</th>
            <th data-sort="industry">Top Industry</th>
            <th class="text-nowrap" data-sort="align">Vote Align</th>
            <th>Badges</th>
          </tr>
        </thead>
        <tbody id="fa-table"><tr><td colspan="8" class="text-muted">Loading…</td></tr></tbody>
      </table>
    </div>
  </details>
</main>

<footer>
  <div class="container text-center small">
    <p class="mb-1">Paid for by Adam Neil Arafat for Congress</p>
    <p class="mb-0">&copy; 2025 Adam Neil Arafat. All Rights Reserved.</p>
  </div>
</footer>

<!-- Member Details Modal -->
<div class="modal fade" id="memberModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="memberTitle" class="modal-title"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs mb-3" role="tablist">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-overview" type="button">Overview</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-money" type="button">Money</button></li>
        </ul>
        <div class="tab-content">
          <div id="tab-overview" class="tab-pane fade show active"><div id="overview-body"></div></div>
          <div id="tab-money" class="tab-pane fade"><div id="money-body"></div></div>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <div class="small text-muted" id="memberMeta"></div>
        <div><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

<!-- Inline demo data fallback -->
<script id="demo-members" type="application/json">
{
  "D000001": {"id":"D000001","name":"Allison Rivera","seat":"WA-10","state":"WA","chamber":"house","party":"D","photo":"assets/members/D000001.jpg"},
  "R000002": {"id":"R000002","name":"Marcus Ellison","seat":"TX-07","state":"TX","chamber":"house","party":"R","photo":"assets/members/R000002.jpg"},
  "S000003": {"id":"S000003","name":"Jamie Chen","seat":"CA","state":"CA","chamber":"senate","party":"D","photo":"assets/members/S000003.jpg"}
}
</script>
<script id="demo-donors" type="application/json">
{
  "D000001": {"pac_pct":0.42,"in_state_dollars":125000,"out_state_dollars":175000,"industries":{"pharma":85000,"tech":40000,"finance":30000}},
  "R000002": {"pac_pct":0.31,"in_state_dollars":210000,"out_state_dollars":150000,"industries":{"oil":120000,"finance":50000}},
  "S000003": {"pac_pct":0.12,"in_state_dollars":400000,"out_state_dollars":220000,"industries":{"tech":140000,"aipac":20000}}
}
</script>
<script id="demo-awards" type="application/json">
{
  "D000001":{"badges":[{"key":"high-pac","label":"High PAC Reliance"}]},
  "R000002":{"badges":[{"key":"dominant-industry","label":"Dominant Industry"}]}
}
</script>
<script id="demo-align" type="application/json">
{
  "D000001":{"donor_alignment_index":0.91},
  "R000002":{"donor_alignment_index":0.76},
  "S000003":{"donor_alignment_index":0.62}
}
</script>

<script>
(async function(){
  const $ = (s, el=document)=>el.querySelector(s);
  const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));
  const v = Date.now();
  const THRESH = { PAC_FLAG: 0.40, INDUSTRY_DOMINATE: 0.35, ALIGN_HIGH: 0.90 };
  const SILO = "data:image/svg+xml;utf8,"+encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect width='64' height='64' fill='#e9eef5'/><g fill='#98a5b4'><circle cx='32' cy='24' r='12'/><rect x='10' y='40' width='44' height='16' rx='8'/></g></svg>");

  const parseInlineJSON = (id, fallback={})=>{ try{ return JSON.parse(document.getElementById(id).textContent.trim()); }catch{ return fallback; } };
  async function tryJSON(path, inlineId){
    try{ const r = await fetch(`${path}?v=${v}`, {cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }
    catch(e){ console.warn('Falling back to inline data for', path, e); return parseInlineJSON(inlineId, {}); }
  }

  $('#load-status').textContent = 'Loading data…';
  const [members, donorsByMember, awardsByMember, voteAlignByMember] = await Promise.all([
    tryJSON('data/members.json','demo-members'),
    tryJSON('data/donors-by-member.json','demo-donors'),
    tryJSON('data/member-awards.json','demo-awards'),
    tryJSON('data/vote-alignments.json','demo-align')
  ]);
  $('#load-status').textContent = 'Data loaded.';

  const pct = n => Math.round((n||0)*100);
  const money = n => '$' + (Math.round(n||0)).toLocaleString();

  const listEl = $('#fa-list');
  const tbody = $('#fa-table');

  // Build local-photo chain: member.photo → assets/members/{id}.jpg → .webp → .png → SILO
  function photoChain(m){
    const id = m?.id || '';
    const chain = [];
    if (m?.photo) chain.push(m.photo);
    if (id) { chain.push(`assets/members/${id}.jpg`, `assets/members/${id}.webp`, `assets/members/${id}.png`); }
    chain.push(SILO);
    return chain.filter(Boolean).filter((v,i,a)=>a.indexOf(v)===i);
  }

  function topIndustry(d){
    if(!d || !d.industries) return {key:'—', share:0};
    const entries = Object.entries(d.industries);
    if(!entries.length) return {key:'—', share:0};
    const total = entries.reduce((s, [,v])=>s+(v||0),0) || 1;
    entries.sort((a,b)=>(b[1]||0)-(a[1]||0));
    const [key, amt] = entries[0];
    return {key, share:(amt||0)/total};
  }

  function computeChips(dRec, aRec, vRec){
    const chips=[];
    const pacPct = dRec?.pac_pct ?? 0;
    if(pacPct >= THRESH.PAC_FLAG){ chips.push(['chip-danger','fa-hand-holding-dollar',`High PAC: ${pct(pacPct)}%`]); }
    else { chips.push(['chip-ok','fa-people-group',`Small donors: ${100-pct(pacPct)}%`]); }

    const in$ = dRec?.in_state_dollars || 0, out$ = dRec?.out_state_dollars || 0;
    if(out$ > in$ * 1.05){ chips.push(['chip-warn','fa-route',`Out-of-state heavy (${money(out$)} vs ${money(in$)})`]); }
    else { chips.push(['chip-ok','fa-house-flag',`Local support (${money(in$)})`]); }

    const ti = topIndustry(dRec);
    if(ti.key !== '—' && ti.share >= THRESH.INDUSTRY_DOMINATE){ chips.push(['chip-danger','fa-industry','Dominant industry: '+ti.key]); }

    const align = vRec?.donor_alignment_index;
    if(typeof align === 'number' && align >= THRESH.ALIGN_HIGH){ chips.push(['chip-danger','fa-scale-balanced',`Donor-aligned votes: ${pct(align)}%`]); }

    if(aRec && Array.isArray(aRec.badges)){ aRec.badges.forEach(b=> chips.push(['chip-danger','fa-award', b.label || b.key])); }
    return chips;
  }

  function rowModel(mid){
    const m = members[mid] || {};
    const d = donorsByMember[mid] || {};
    const a = awardsByMember[mid] || null;
    const v = voteAlignByMember[mid] || null;
    const ti = topIndustry(d);
    const pacP = pct(d.pac_pct||0), smlP = 100 - pacP;
    return {
      mid, name: m.name || mid, seat: m.seat || (m.state || '—'), party: m.party || '',
      chamber:(m.chamber||'').toLowerCase(), state:(m.state||'').toLowerCase(),
      photos: photoChain(m),
      pacP, smlP, in$: d.in_state_dollars||0, out$: d.out_state_dollars||0,
      topIndustryKey: ti.key, topIndustryShare: ti.share,
      align: (typeof (v&&v.donor_alignment_index)==='number') ? pct(v.donor_alignment_index) : null,
      chips: computeChips(d,a,v),
      industries: d.industries || {}
    };
  }

  function chipHTML(chips){
    return chips.map(([cls,icon,label])=>`<span class="chip ${cls}" title="${label}"><i class="fa-solid ${icon}"></i>${label}</span>`).join(' ');
  }

  function listHTML(d){
    const [s0,s1,s2,s3] = d.photos;
    return `<article class="person" data-mid="${d.mid}" data-name="${d.name.toLowerCase()}" data-seat="${d.seat.toLowerCase()}" data-state="${d.state}" data-chamber="${d.chamber}" tabindex="0" role="button" aria-label="Open details for ${d.name}">
      <div class="rowwrap">
        <div class="thumb">
          <img class="headshot" src="${s0}" alt="${d.name} headshot" loading="lazy"
               data-s0="${s0||''}" data-s1="${s1||''}" data-s2="${s2||''}" data-s3="${s3||''}">
        </div>
        <div class="pdata">
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <h3 class="name">${d.name}</h3>
              <div class="sub">${d.seat}${d.party ? ' • '+d.party : ''}</div>
              <div class="chips">${chipHTML(d.chips)}</div>
            </div>
            <div class="actions">
              <button class="btn btn-sm btn-primary open" data-open="${d.mid}" type="button"><i class="fa-solid fa-circle-info me-1"></i>Details</button>
            </div>
          </div>
          <div class="mt-2 small text-muted">
            PAC: <strong>${d.pacP}%</strong> • Small: <strong>${d.smlP}%</strong> • In/Out: <strong>${money(d.in$)}</strong> / <strong>${money(d.out$)}</strong> • Top: <strong>${d.topIndustryKey==='—'?'—':`${d.topIndustryKey} (${pct(d.topIndustryShare)}%)`}</strong> • Align: <strong>${d.align===null?'—':d.align+'%'}</strong>
          </div>
        </div>
      </div>
    </article>`;
  }

  function tableRowHTML(d){
    const [s0,s1,s2,s3] = d.photos;
    return `<tr data-mid="${d.mid}" data-name="${d.name.toLowerCase()}" data-seat="${d.seat.toLowerCase()}" data-state="${d.state}" data-chamber="${d.chamber}">
      <td>
        <div class="d-flex align-items-center gap-2">
          <img class="headshot" src="${s0}" alt="${d.name} headshot" loading="lazy"
               style="width:36px;height:36px;object-fit:cover;border-radius:50%;border:1px solid var(--ring-strong)"
               data-s0="${s0||''}" data-s1="${s1||''}" data-s2="${s2||''}" data-s3="${s3||''}">
          <div><div class="fw-bold">${d.name}</div><div class="text-muted small">${d.party}</div></div>
        </div>
      </td>
      <td>${d.seat}</td>
      <td data-val="${d.pacP}">${d.pacP}%</td>
      <td data-val="${d.smlP}">${d.smlP}%</td>
      <td data-val="${d.in$ - d.out$}">${money(d.in$)} / ${money(d.out$)}</td>
      <td data-val="${d.topIndustryShare}">${d.topIndustryKey==='—' ? '—' : `${d.topIndustryKey} (${pct(d.topIndustryShare)}%)`}</td>
      <td data-val="${d.align ?? -1}">${d.align===null ? '—' : d.align+'%'}</td>
      <td style="min-width:280px">${chipHTML(d.chips)}</td>
    </tr>`;
  }

  function attachPhotoFallback(scope=document){
    $$('.headshot', scope).forEach(img=>{
      let i=0;
      const chain=[img.dataset.s0,img.dataset.s1,img.dataset.s2,img.dataset.s3].filter(Boolean);
      img.addEventListener('error', function onErr(){
        i++; if(i<chain.length){ img.src = chain[i]; } else { img.removeEventListener('error', onErr); }
      });
    });
  }

  function rebuild(){
    const mids = Object.keys(members||{});
    if(!mids.length){
      $('#fa-list').innerHTML = `<div class="text-muted">No roster found.</div>`;
      $('#fa-table').innerHTML = `<tr><td colspan="8" class="text-muted">No roster found.</td></tr>`;
      return;
    }
    const rows = mids.map(rowModel);
    $('#fa-list').innerHTML = rows.map(listHTML).join('');
    attachPhotoFallback($('#fa-list'));
    $$('#fa-list .person').forEach(el=>{
      const mid = el.getAttribute('data-mid');
      el.addEventListener('click', ()=>openModal(mid));
      el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openModal(mid);} });
    });
    $$('#fa-list [data-open]').forEach(btn=> btn.addEventListener('click', e=>{ e.stopPropagation(); openModal(btn.getAttribute('data-open')); }));
    $('#fa-table').innerHTML = rows.map(tableRowHTML).join('');
    attachPhotoFallback($('#fa-table'));
    $$('#fa-table tr[data-mid]').forEach(tr=> tr.addEventListener('click', ()=>openModal(tr.getAttribute('data-mid'))));
  }
  rebuild();

  // Filtering + aggregates
  const qInput=$('#fa-member'), chamberSel=$('#fa-chamber'), industrySel=$('#fa-industry'), resetBtn=$('#fa-reset');

  function passesIndustryFilter(mid, wanted){
    if(!wanted) return true;
    const inds = (donorsByMember[mid]||{}).industries || {};
    return Object.keys(inds).map(k=>k.toLowerCase()).includes(wanted.toLowerCase());
  }

  function computeAggregates(){
    const mids = Object.keys(members||{});
    const visible = mids.filter(mid=>{
      const el = document.querySelector(`.person[data-mid="${CSS.escape(mid)}"]`);
      return el && el.style.display !== 'none';
    });
    if(!visible.length) return null;

    let pacSum=0,pacCount=0,inSum=0,outSum=0,indTallies={}; let alignSum=0,alignCount=0;
    visible.forEach(mid=>{
      const d = donorsByMember[mid]||{}, v = voteAlignByMember[mid]||{};
      if(typeof d.pac_pct==='number'){ pacSum+=d.pac_pct; pacCount++; }
      inSum += d.in_state_dollars||0; outSum += d.out_state_dollars||0;
      Object.entries(d.industries||{}).forEach(([k,val])=> indTallies[k]=(indTallies[k]||0)+(val||0));
      if(typeof v.donor_alignment_index==='number'){ alignSum+=v.donor_alignment_index; alignCount++; }
    });
    const inds = Object.entries(indTallies).sort((a,b)=>(b[1]||0)-(a[1]||0));
    const [topKey, topAmt]=inds[0]||['—',0]; const total = inds.reduce((s,[,v])=>s+(v||0),0)||1;
    return { pacAvg: pacCount? pacSum/pacCount:0, inSum, outSum, topIndustryKey: topKey, topIndustryShare: topAmt/total, alignAvg: alignCount? alignSum/alignCount:null };
  }

  function renderHeadline(){
    const agg = computeAggregates(); const p100=n=>Math.round((n||0)*100);
    if(!agg){ $('#m-pac-small').textContent='—'; $('#m-geo').textContent='—'; $('#m-top-industry').textContent='—'; $('#m-vote-align').textContent='—'; return; }
    $('#m-pac-small').textContent = `${p100(agg.pacAvg)}% PAC / ${100-p100(agg.pacAvg)}% small`;
    $('#m-geo').textContent = `${money(agg.inSum)} in / ${money(agg.outSum)} out`;
    $('#m-top-industry').textContent = agg.topIndustryKey==='—'?'—':`${agg.topIndustryKey} (${p100(agg.topIndustryShare)}%)`;
    $('#m-vote-align').textContent = (agg.alignAvg==null)?'—':`${p100(agg.alignAvg)}%`;
  }

  function applyFilters(pushState=true){
    const q=(qInput.value||'').trim().toLowerCase(), ch=(chamberSel.value||'').toLowerCase(), ind=(industrySel.value||'').toLowerCase();
    const listRows = $$('#fa-list .person'); let visible=0;
    listRows.forEach(row=>{
      const mid=row.getAttribute('data-mid'), nm=row.getAttribute('data-name')||'', st=row.getAttribute('data-state')||'', seat=row.getAttribute('data-seat')||'', chamber=row.getAttribute('data-chamber')||'';
      const textHit=!q || nm.includes(q)||st.includes(q)||seat.includes(q);
      const chamberHit=!ch || chamber===ch; const industryHit=passesIndustryFilter(mid, ind);
      const show=textHit&&chamberHit&&industryHit; row.style.display=show?'':'none'; if(show) visible++;
    });
    $$('#fa-table tr[data-mid]').forEach(tr=>{
      const mid=tr.getAttribute('data-mid'), nm=tr.getAttribute('data-name')||'', st=tr.getAttribute('data-state')||'', seat=tr.getAttribute('data-seat')||'', chamber=tr.getAttribute('data-chamber')||'';
      const textHit=!q||nm.includes(q)||st.includes(q)||seat.includes(q); const chamberHit=!ch||chamber===ch; const industryHit=passesIndustryFilter(mid, ind);
      tr.style.display=(textHit&&chamberHit&&industryHit)?'':'none';
    });
    $('#load-status').textContent = `Showing ${visible} row(s).`;

    if(pushState){
      const p=new URLSearchParams(); if(q) p.set('q',q); if(ch) p.set('chamber',ch); if(ind) p.set('industry',ind);
      history.replaceState({}, '', p.toString()? `${location.pathname}?${p}` : location.pathname);
    }
    renderHeadline();
  }

  (function fromURL(){ const params=new URLSearchParams(location.search); const q=params.get('q')||'', ch=params.get('chamber')||'', ind=params.get('industry')||''; if(q) $('#fa-member').value=q; if(ch) $('#fa-chamber').value=ch; if(ind) $('#fa-industry').value=ind; })();
  $('#fa-member').addEventListener('input', ()=>applyFilters());
  $('#fa-chamber').addEventListener('change', ()=>applyFilters());
  $('#fa-industry').addEventListener('change', ()=>applyFilters());
  $('#fa-reset').addEventListener('click', ()=>{ $('#fa-member').value=''; $('#fa-chamber').value=''; $('#fa-industry').value=''; applyFilters(); });

  let sortState={key:null,dir:1};
  $('#fa-table-el thead').addEventListener('click', e=>{
    const th=e.target.closest('th[data-sort]'); if(!th) return;
    const key=th.getAttribute('data-sort'); const dir=(sortState.key===key)?-sortState.dir:1; sortState={key,dir};
    $$('#fa-table-el thead th').forEach(h=>h.classList.remove('sorted-asc','sorted-desc')); th.classList.add(dir>0?'sorted-asc':'sorted-desc');
    const all=$$('#fa-table tr[data-mid]'), vis=all.filter(tr=>tr.style.display!=='none'), hid=all.filter(tr=>tr.style.display==='none');
    const getter={name:tr=>(tr.querySelector('td .fw-bold')?.textContent||'').toLowerCase(), seat:tr=>(tr.children[1]?.textContent||'').toLowerCase(), pac:tr=>Number(tr.children[2]?.getAttribute('data-val')||0), small:tr=>Number(tr.children[3]?.getAttribute('data-val')||0), geo:tr=>Number(tr.children[4]?.getAttribute('data-val')||0), industry:tr=>Number(tr.children[5]?.getAttribute('data-val')||0), align:tr=>Number(tr.children[6]?.getAttribute('data-val')||-1) }[key];
    vis.sort((a,b)=>{ const va=getter(a), vb=getter(b); return (typeof va==='number' && typeof vb==='number' ? (va-vb) : String(va).localeCompare(String(vb))) * dir; });
    const frag=document.createDocumentFragment(); vis.forEach(r=>frag.appendChild(r)); hid.forEach(h=>frag.appendChild(h)); $('#fa-table').innerHTML=''; $('#fa-table').appendChild(frag);
  });

  $('#btn-export').addEventListener('click', ()=>{
    const rows=$$('#fa-list .person').filter(r=>r.style.display!=='none'); if(!rows.length) return;
    const esc=s=>`"${String(s).replace(/"/g,'""')}"`, header=['Member','Seat','PAC %','Small %','In $','Out $','Top Industry','Vote Align','Badges'], csv=[header.join(',')];
    rows.forEach(row=>{
      const mid=row.getAttribute('data-mid'); const d=rowModel(mid); const badges=d.chips.map(ch=>ch[2]).join(' | ');
      csv.push([d.name,d.seat,`${d.pacP}%`,`${d.smlP}%`,money(d.in$),money(d.out$), d.topIndustryKey==='—'?'—':`${d.topIndustryKey} (${pct(d.topIndustryShare)}%)`, d.align===null?'—':`${d.align}%`, badges].map(esc).join(','));
    });
    const blob=new Blob([csv.join('\n')],{typ
