<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin – Apply Vote Badges</title>
  <style>
    :root {
      --ink: #122133;
      --muted: #5b6b7c;
      --soft: #f6f9fc;
      --brand: #0d3b66;
      --ring: rgba(13, 59, 102, 0.12);
      --ring-strong: rgba(13, 59, 102, 0.22);
    }
    html, body {
      background: var(--soft);
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 1rem;
    }
    h1 {
      font-weight: 900;
      margin-top: 1rem;
    }
    .field {
      margin-bottom: 1rem;
    }
    label {
      font-weight: 600;
    }
    select, input[type="password"] {
      padding: 0.4rem 0.6rem;
      border: 1px solid var(--ring);
      border-radius: 6px;
      width: 100%;
      max-width: 100%;
    }
    .members-list {
      max-height: 320px;
      overflow-y: auto;
      border: 1px solid var(--ring);
      border-radius: 8px;
      padding: 0.5rem;
    }
    .member-item {
      display: flex;
      align-items: center;
      padding: 0.25rem 0;
    }
    .member-item input[type="checkbox"] {
      margin-right: 0.5rem;
    }
    .buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    button {
      padding: 0.5rem 0.9rem;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button.primary {
      background: var(--brand);
      color: #fff;
    }
    button.danger {
      background: #b42318;
      color: #fff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status {
      margin-top: 1rem;
      font-size: 0.9rem;
      color: var(--muted);
    }
  </style>
  <script src="/assets/js/accountability.js"></script>
</head>
<body>
  <div class="container">
    <h1>Admin &ndash; Apply Vote Badges</h1>
    <p>Assign or remove vote-based badges for multiple members at once. These edits are persisted directly to the repository using your personal access token. Enter your token below each time you commit changes. Nothing is stored locally.</p>
    <div class="field">
      <label for="githubToken">GitHub Personal Access Token</label>
      <input type="password" id="githubToken" placeholder="ghp_..." />
    </div>
    <div class="field">
      <label for="billSelect">Select Bill/Badge</label>
      <select id="billSelect">
        <option value="">-- choose a bill --</option>
      </select>
    </div>
    <div class="field">
      <label for="voteSelect">Vote Position</label>
      <select id="voteSelect">
        <option value="Yea">Yea (Yes)</option>
        <option value="Nay">Nay (No)</option>
      </select>
    </div>
    <div class="field">
      <label>Select Members</label>
      <div class="members-list" id="membersList"></div>
    </div>
    <div class="buttons">
      <button class="primary" id="applyBtn">Apply Badge</button>
      <button class="danger" id="removeBtn">Remove Badge</button>
    </div>
    <div class="status" id="status"></div>
  </div>
  <script>
    let localOverrides = {};
    document.addEventListener('DOMContentLoaded', async () => {
      const { data, overrides, bills } = await Accountability.loadAll();
      localOverrides = JSON.parse(JSON.stringify(overrides || {}));
      // Populate bills
      const billSelect = document.getElementById('billSelect');
      bills.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = `${b.badge} – ${b.title}`;
        billSelect.appendChild(opt);
      });
      // Populate members
      const membersList = document.getElementById('membersList');
      data.forEach(rec => {
        const item = document.createElement('div');
        item.className = 'member-item';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = rec.person_id;
        const label = document.createElement('span');
        const dist = rec.district ? `–${rec.district}` : '';
        label.textContent = `${rec.name} (${rec.party}, ${rec.chamber}, ${rec.state}${dist})`;
        item.appendChild(cb);
        item.appendChild(label);
        membersList.appendChild(item);
      });
      // Button handlers
      document.getElementById('applyBtn').addEventListener('click', () => {
        handleApply(true);
      });
      document.getElementById('removeBtn').addEventListener('click', () => {
        handleApply(false);
      });
    });
    /**
     * Apply or remove a badge for selected members.
     * @param {boolean} apply true to apply, false to remove
     */
    async function handleApply(apply) {
      const status = document.getElementById('status');
      status.textContent = '';
      const token = document.getElementById('githubToken').value.trim();
      const billId = document.getElementById('billSelect').value;
      const vote = document.getElementById('voteSelect').value;
      if (!token) {
        status.textContent = 'Please enter your GitHub token.';
        return;
      }
      if (!billId) {
        status.textContent = 'Please select a bill.';
        return;
      }
      // Gather selected members
      const cbs = document.querySelectorAll('#membersList input[type="checkbox"]:checked');
      if (cbs.length === 0) {
        status.textContent = 'Select at least one member.';
        return;
      }
      // Update localOverrides
      cbs.forEach(cb => {
        const pid = cb.value;
        if (!localOverrides[pid]) localOverrides[pid] = {};
        if (apply) {
          localOverrides[pid][billId] = vote;
        } else {
          delete localOverrides[pid][billId];
          if (Object.keys(localOverrides[pid]).length === 0) delete localOverrides[pid];
        }
      });
      status.textContent = 'Updating…';
      try {
        await Accountability.saveOverridesToGitHub(token, localOverrides);
        status.textContent = 'Overrides updated successfully.';
      } catch (err) {
        console.error(err);
        status.textContent = `Error: ${err.message}`;
      }
    }
  </script>
</body>
</html>