<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Evergreen Admin — Bulk NO Vote Builder</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .chip img{width:36px;height:44px;object-fit:cover;border-radius:.3rem;border:1px solid #dfe6ee;margin-right:.5rem}
  .chip{display:flex;align-items:center;gap:.5rem}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
</style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="h4 mb-1">Bulk NO Vote Builder <span class="badge bg-secondary">Private</span></h1>
  <p class="text-muted small mb-3">Mode: <span class="badge bg-success">Secret backend, no token / no admin key in browser</span></p>

  <!-- Backend endpoint (hardcoded defaults; change if your route differs) -->
  <div class="row g-2 mb-3">
    <div class="col-md-6">
      <label class="form-label mb-1">Append Votes Endpoint</label>
      <input id="epVotes" class="form-control form-control-sm mono" value="/api/append-votes"/>
    </div>
    <div class="col-md-6">
      <label class="form-label mb-1">Clear Badges Endpoint</label>
      <input id="epBadges" class="form-control form-control-sm mono" value="/api/clear-badges"/>
    </div>
  </div>

  <!-- Filters -->
  <div class="row g-2 mb-3">
    <div class="col-md-2">
      <select id="fChamber" class="form-select form-select-sm">
        <option value="">All Chambers</option>
        <option value="house">House</option>
        <option value="senate">Senate</option>
      </select>
    </div>
    <div class="col-md-2">
      <select id="fParty" class="form-select form-select-sm">
        <option value="">All Parties</option>
        <option value="D">Democrat</option>
        <option value="R">Republican</option>
        <option value="I">Independent</option>
      </select>
    </div>
    <div class="col-md-2">
      <input id="fState" class="form-control form-control-sm" placeholder="State (WA, OH)"/>
    </div>
    <div class="col-md-3">
      <input id="fSearch" class="form-control form-control-sm" placeholder="Search name"/>
    </div>
    <div class="col-md-3">
      <select id="fSort" class="form-select form-select-sm">
        <option value="last">Sort: Last Name</option>
        <option value="party">Sort: Party</option>
        <option value="state">Sort: State</option>
        <option value="chamber">Sort: Chamber</option>
      </select>
    </div>
  </div>

  <!-- Builder -->
  <div class="row g-2 mb-3">
    <div class="col-md-4">
      <label class="form-label mb-1">Choose bill(s)</label>
      <select id="bills" class="form-select form-select-sm" multiple size="6">
        <option value="grocery">grocery — Fair Food & Grocery Competition</option>
        <option value="childcare">childcare — Affordable Child & Dependent Care</option>
        <option value="jobs">jobs — Good Jobs & Fair Pay</option>
        <option value="housing">housing — 3% First-Time Buyer</option>
        <option value="socialsec">socialsec — Social Security Solvency</option>
        <option value="health">health — Universal Health Coverage</option>
        <option value="minibus">minibus — Implementation Safeguards</option>
        <option value="csr">csr — CSR Tax</option>
        <option value="taxfair">taxfair — Tax Fairness</option>
        <option value="comms">comms — Communications Integrity</option>
        <option value="justify">justify — Vote Justification</option>
        <option value="impeach">impeach — Impeachment Continuity</option>
        <option value="emerg">emerg — Emergency Spend Pilot</option>
        <option value="holman">holman — Holman Amendments</option>
        <option value="gaodash">gaodash — GAO Dashboard</option>
        <option value="clean">clean — Clean Energy/Public Lands</option>
        <option value="water">water — Water/Wastewater Riders</option>
      </select>
      <div class="form-text">Hold Ctrl/Cmd to select multiple.</div>
    </div>
    <div class="col-md-3">
      <label class="form-label mb-1">Vote date</label>
      <input id="date" type="date" class="form-control form-control-sm"/>
    </div>
    <div class="col-md-5">
      <label class="form-label mb-1">Optional nickname</label>
      <input id="nickname" class="form-control form-control-sm" placeholder="e.g., 'Grocery Gouger'"/>
    </div>
  </div>

  <div class="d-flex gap-2 mb-2">
    <button id="selectAll" class="btn btn-outline-secondary btn-sm">Select All (filtered)</button>
    <button id="clearSel" class="btn btn-outline-secondary btn-sm">Clear Selection</button>

    <div class="ms-auto d-flex gap-2">
      <button id="make" class="btn btn-outline-dark btn-sm">Preview JSON for Selected</button>
      <button id="apply" class="btn btn-primary btn-sm">Apply & Save Votes</button>
      <button id="removeBadges" class="btn btn-warning btn-sm">Remove Badges for Selected</button>
    </div>
  </div>

  <div class="border bg-white p-2 rounded" style="max-height:50vh;overflow:auto" id="list">
    <div class="text-muted">Loading members…</div>
  </div>

  <div class="mt-3">
    <label class="form-label">Output (preview)</label>
    <textarea id="out" class="form-control mono" rows="8"></textarea>
    <div class="mt-2 d-flex gap-2">
      <button id="copy" class="btn btn-outline-secondary btn-sm">Copy to Clipboard</button>
      <button id="download" class="btn btn-success btn-sm">Download votes_append.json</button>
    </div>
  </div>
</div>

<script>
/* ========= State ========= */
let MEMBERS = {};
let SELECTED = new Set();

/* ========= Constants ========= */
const EP_VOTES  = () => (document.getElementById('epVotes').value.trim()  || "/api/append-votes");
const EP_BADGES = () => (document.getElementById('epBadges').value.trim() || "/api/clear-badges");

/* ========= Load current legislators ========= */
async function loadMembers() {
  const url = "https://raw.githubusercontent.com/unitedstates/congress-legislators/refs/heads/gh-pages/legislators-current.json";
  const data = await fetch(url, { cache: "no-store" }).then(r => r.json());
  for (const m of data) {
    const bioguide = m.id?.bioguide;
    if (!bioguide) continue;
    const lastTerm = (m.terms || []).slice(-1)[0] || {};
    MEMBERS[bioguide] = {
      bioguide,
      first: m.name?.first || "",
      last: m.name?.last || "",
      name: `${m.name?.first || ""} ${m.name?.last || ""}`.trim(),
      partyFull: lastTerm.party || "",
      party: partyLetter(lastTerm.party || ""),   // normalize to D/R/I
      chamber: lastTerm.type === "sen" ? "senate" : "house",
      state: lastTerm.state || "",
      district: lastTerm.type === "rep" ? (lastTerm.district ?? "") : "",
      photo: `https://unitedstates.github.io/images/congress/225x275/${bioguide}.jpg`
    };
  }
}

function partyLetter(p){
  const map = {
    "Democrat":"D", "Democratic":"D", "Democratic-Farmer-Labor":"D",
    "Republican":"R",
    "Independent":"I"
  };
  return map[p] || (p ? p[0].toUpperCase() : "");
}
function districtLabel(d){
  if (d === 0 || d === "0" || d === "" || d === null || typeof d === "undefined") return "AL";
  return String(d);
}

/* ========= Render list + filters ========= */
function renderList() {
  const list = document.getElementById('list');
  const q = document.getElementById('fSearch').value.toLowerCase().trim();
  const party = document.getElementById('fParty').value; // D/R/I
  const chamber = document.getElementById('fChamber').value; // house/senate
  const state = document.getElementById('fState').value.toUpperCase().trim();
  const sort = document.getElementById('fSort').value;

  let arr = Object.values(MEMBERS);
  if (party) arr = arr.filter(m=>m.party===party);
  if (chamber) arr = arr.filter(m=>m.chamber===chamber);
  if (state) arr = arr.filter(m=>m.state===state);
  if (q) arr = arr.filter(m=> m.name.toLowerCase().includes(q));

  arr.sort((a,b)=>{
    if (sort==='party') return (a.party||'').localeCompare(b.party||'') || a.last.localeCompare(b.last);
    if (sort==='state') return (a.state||'').localeCompare(b.state||'') || a.last.localeCompare(b.last);
    if (sort==='chamber') return (a.chamber||'').localeCompare(b.chamber||'') || a.last.localeCompare(b.last);
    return a.last.localeCompare(b.last);
  });

  list.innerHTML = arr.map(m=>`
    <div class="d-flex align-items-center justify-content-between border-bottom py-2">
      <div class="chip">
        <img src="${m.photo}" alt="${m.name}" loading="lazy"/>
        <div>
          <div class="fw-semibold">
            ${m.name}
            <span class="text-muted">
              (${m.chamber==='house'? `${m.state}-${districtLabel(m.district)}` : m.state}, ${m.partyFull})
            </span>
          </div>
          <div class="small text-muted">${m.bioguide}</div>
        </div>
      </div>
      <div>
        <input type="checkbox" class="form-check-input" data-id="${m.bioguide}" ${SELECTED.has(m.bioguide)?'checked':''}/>
      </div>
    </div>
  `).join('') || '<div class="text-muted p-2">No matches.</div>';

  list.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const id = e.target.dataset.id;
      if (e.target.checked) SELECTED.add(id); else SELECTED.delete(id);
    });
  });
}

/* ========= Build rows (multi-bill) ========= */
function getSelectedBills(){
  return Array.from(document.getElementById('bills').selectedOptions).map(o=>o.value);
}

function buildRows(){
  const bills = getSelectedBills();
  const date = document.getElementById('date').value;
  const nick = document.getElementById('nickname').value.trim();
  if (!bills.length) { alert('Pick at least one bill.'); return []; }
  if (!date) { alert('Pick a vote date.'); return []; }
  if (SELECTED.size===0) { alert('Select at least one member.'); return []; }

  const rows = [];
  for (const id of Array.from(SELECTED)) {
    for (const bill of bills) {
      const row = { member_id: id, bill_id: bill, vote: "NO", vote_date: date };
      if (nick) row.nickname = nick;
      rows.push(row);
    }
  }
  return rows;
}

function buildOutput() {
  const rows = buildRows();
  if (!rows.length) return;
  document.getElementById('out').value = JSON.stringify(rows, null, 2);
}

/* ========= Apply via backend ========= */
async function applyVotes(){
  const rows = buildRows();
  if (!rows.length) return;

  let res;
  try{
    res = await fetch(EP_VOTES(), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ rows })
    });
  }catch(e){
    alert("Network error calling append-votes API.");
    return;
  }

  if (!res.ok) {
    const text = await res.text().catch(()=> "");
    alert("Save failed: " + text);
    return;
  }

  const j = await res.json().catch(()=>({}));
  document.getElementById('out').value = JSON.stringify(rows, null, 2);
  alert(`Saved ${rows.length} row(s).${j?.appended?` Appended: ${j.appended}.`:''}\nSite will reflect after Pages rebuild.`);
}

async function removeBadges(){
  if (SELECTED.size === 0) { alert('Select at least one member.'); return; }
  const members = Array.from(SELECTED);

  let res;
  try{
    res = await fetch(EP_BADGES(), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ members })
    });
  }catch(e){
    alert("Network error calling clear-badges API.");
    return;
  }

  if (!res.ok) {
    const text = await res.text().catch(()=> "");
    alert("Clear failed: " + text);
    return;
  }

  const j = await res.json().catch(()=>({}));
  document.getElementById('out').value = JSON.stringify({ cleared: members }, null, 2);
  alert(`Cleared badges for ${members.length} member(s).${j?.changed?` Changed: ${j.changed}.`:''}\nRefresh the site to see updates.`);
}

/* ========= Wiring ========= */
document.getElementById('make').addEventListener('click', buildOutput);
document.getElementById('apply').addEventListener('click', applyVotes);
document.getElementById('removeBadges').addEventListener('click', removeBadges);

document.getElementById('copy').addEventListener('click', ()=>navigator.clipboard.writeText(document.getElementById('out').value));
document.getElementById('download').addEventListener('click', ()=>{
  const txt = document.getElementById('out').value.trim();
  if (!txt) return;
  const blob = new Blob([txt], {type: "application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "votes_append.json";
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById('selectAll').addEventListener('click', ()=>{
  document.querySelectorAll('#list input[type=checkbox]').forEach(cb=>{ cb.checked=true; SELECTED.add(cb.dataset.id); });
});
document.getElementById('clearSel').addEventListener('click', ()=>{
  SELECTED.clear(); renderList();
});

['fChamber','fParty','fState','fSearch','fSort'].forEach(id=>{
  document.getElementById(id).addEventListener('input', renderList);
  document.getElementById(id).addEventListener('change', renderList);
});

/* ========= Init ========= */
(async function(){
  await loadMembers();
  renderList();
})();
</script>
</body>
</html>
