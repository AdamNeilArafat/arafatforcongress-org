<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Apply Bill Badges</title>
  <style>
    :root{--ink:#122133;--muted:#5b6b7c;--soft:#f6f9fc;--brand:#0d3b66;--ring:rgba(13,59,102,.12)}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:var(--ink);max-width:1100px;margin:0 auto;padding:1rem}
    h1{font-weight:900}
    .two{display:grid;grid-template-columns:1fr 2fr;gap:1rem}
    .list{max-height:70vh;overflow:auto;border:1px solid #eee;border-radius:10px;padding:.5rem}
    .pill{border:1px solid #ddd;border-radius:999px;padding:.15rem .5rem;margin:.15rem;display:inline-block}
    .bar{display:flex;gap:.5rem;align-items:center;margin:.5rem 0 1rem 0}
    input[type="search"]{padding:.4rem .6rem;border:1px solid var(--ring);border-radius:6px}
    .btn{padding:.45rem .7rem;border-radius:8px;border:1px solid var(--ring);background:#fff;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.warn{background:#fff7e0;border-color:#ffe5a3}
    pre{background:#f8fafc;border:1px solid #eef2f7;border-radius:10px;padding:.75rem}
    small.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <h1>Admin — Apply Bill Badges</h1>

  <div class="bar">
    <button id="setToken" class="btn">Set/Update Admin Token</button>
    <button id="clearToken" class="btn warn">Clear Token</button>
    <span id="tokState" class="muted"></span>
  </div>
  <p class="muted"><small class="mono">Fine‑grained PAT scope: Contents (Read & Write) on <b>this</b> repo only.</small></p>

  <div class="two">
    <div>
      <h3>Bills</h3>
      <input id="qb" type="search" placeholder="Search bills" style="width:100%;margin:.25rem 0 .5rem 0"/>
      <div id="billList" class="list"></div>
      <hr/>
      <h3>People</h3>
      <input id="qp" type="search" placeholder="Search people" style="width:100%;margin:.25rem 0 .5rem 0"/>
      <div id="personList" class="list"></div>
    </div>

    <div>
      <h3>Selections</h3>
      <div>Selected bill: <span id="selBill" style="font-weight:700">(none)</span></div>
      <div class="bar" style="margin-top:.5rem">
        <label>Vote shown on card:</label>
        <select id="voteVal">
          <option value="Yea">Yea</option>
          <option value="Nay">Nay</option>
        </select>
      </div>
      <div style="margin:.5rem 0">Selected people: <span id="selPeople"></span></div>
      <div class="bar">
        <button id="apply" class="btn primary">Apply to Selected</button>
        <button id="undo" class="btn">Undo for Selected</button>
      </div>
      <h3 style="margin-top:1rem">Preview JSON</h3>
      <pre id="preview">{}</pre>
    </div>
  </div>

  <script>
    // Configure your repo here:
    const owner = 'AdamNeilArafat';
    const repo  = 'arafatforcongress-org';
    const path  = 'data/accountability_overrides.json';
    const tokenKey='ADMIN_PAT';

    let rows=[], bills=[], overrides={applied:[],badges:{}};
    let selBill=null; const selPeople=new Set();

    const getTok=()=> localStorage.getItem(tokenKey)||'';
    const setToken=()=>{
      const v=prompt('Paste fine‑grained GitHub PAT (Contents: Read & Write on this repo).');
      if(v) localStorage.setItem(tokenKey,v);
      refreshTokState();
    };
    const clearToken=()=>{ localStorage.removeItem(tokenKey); refreshTokState(); };
    const refreshTokState=()=> document.getElementById('tokState').textContent = getTok()? 'Token set ✓' : 'No token';

    document.getElementById('setToken').onclick=setToken;
    document.getElementById('clearToken').onclick=clearToken;

    async function load(){
      [rows, bills, overrides] = await Promise.all([
        fetch('/data/financial_alignment.json',{cache:'no-store'}).then(r=>r.json()),
        fetch('/data/bills.json',{cache:'no-store'}).then(r=>r.json()).catch(()=>[]),
        fetch('/data/accountability_overrides.json',{cache:'no-store'}).then(r=>r.json()).catch(()=>({applied:[],badges:{}}))
      ]);
      renderBills(); renderPeople(); updatePreview(); refreshTokState();
    }

    function renderBills(q=''){
      const el=document.getElementById('billList');
      const list=bills.filter(b=>(b.title+b.short+b.bill_id+(b.badge||'')).toLowerCase().includes(q.toLowerCase()));
      el.innerHTML=list.map(b=>`<div><label><input type="radio" name="bill" value="${b.bill_id}"> ${b.short||b.title} <small class="muted">(${b.badge||'badge'})</small></label></div>`).join('');
      el.querySelectorAll('input[name=bill]').forEach(r=>r.addEventListener('change',()=>{
        selBill=bills.find(b=>b.bill_id===r.value);
        document.getElementById('selBill').textContent = `${selBill.short||selBill.title} → ${selBill.badge||'badge'}`;
        updatePreview();
      }));
      document.getElementById('qb').oninput=(e)=>renderBills(e.target.value);
    }

    function renderPeople(q=''){
      const el=document.getElementById('personList');
      const list=rows.filter(r=>(r.name+r.state+r.district).toLowerCase().includes(q.toLowerCase()));
      el.innerHTML=list.map(r=>`<div><label><input type="checkbox" data-id="${r.person_id}"> ${r.name} <small class="muted">${r.party} • ${r.chamber} • ${r.state}${r.district?'-'+r.district:''}</small></label></div>`).join('');
      el.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.addEventListener('change',()=>{
        const id=cb.getAttribute('data-id'); cb.checked? selPeople.add(id): selPeople.delete(id);
        renderSelPeople(); updatePreview();
      }));
      document.getElementById('qp').oninput=(e)=>renderPeople(e.target.value);
    }

    function renderSelPeople(){
      const el=document.getElementById('selPeople');
      el.innerHTML = Array.from(selPeople).map(id=>{
        const r=rows.find(x=>x.person_id===id); return `<span class="pill">${r?.name||id}</span>`;
      }).join('');
    }

    function applyInMemory(){
      if(!selBill||!selPeople.size) return;
      const vote=document.getElementById('voteVal').value;
      for(const id of selPeople){
        overrides.applied = overrides.applied.filter(x=> !(x.person_id===id && x.bill_id===selBill.bill_id));
        overrides.applied.push({person_id:id, bill_id: selBill.bill_id, vote, badge: selBill.badge || null});
        const b=(overrides.badges[id]||[]);
        if(selBill.badge && !b.includes(selBill.badge)) b.push(selBill.badge);
        overrides.badges[id]=Array.from(new Set(b));
      }
    }

    function undoInMemory(){
      if(!selBill||!selPeople.size) return;
      for(const id of selPeople){
        overrides.applied = overrides.applied.filter(x=> !(x.person_id===id && x.bill_id===selBill.bill_id));
        if(selBill.badge){
          overrides.badges[id] = (overrides.badges[id]||[]).filter(x=> x!==selBill.badge);
        }
      }
    }

    async function commitOverrides(message){
      const token=getTok(); if(!token){ alert('Set your admin token first.'); return; }
      const url=`https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
      const headers={'Accept':'application/vnd.github+json','Authorization':`Bearer ${token}`};
      // get current sha (if file exists)
      let sha=null;
      const head=await fetch(url,{headers});
      if(head.status===200){ const j=await head.json(); sha=j.sha; }
      // PUT new content
      const body = {
        message,
        content: btoa(unescape(encodeURIComponent(JSON.stringify(overrides,null,2)))),
        sha
      };
      const res=await fetch(url,{method:'PUT',headers,body:JSON.stringify(body)});
      if(!res.ok){ const t=await res.text(); throw new Error(t); }
      return await res.json();
    }

    function updatePreview(){
      document.getElementById('preview').textContent = JSON.stringify(overrides,null,2);
    }

    document.getElementById('apply').onclick= async ()=>{
      if(!selBill||!selPeople.size) return alert('Pick a bill and at least one person.');
      applyInMemory(); updatePreview();
      try{ await commitOverrides(`admin: apply ${selBill.badge||'badge'} via ${selBill.bill_id} to ${selPeople.size} member(s)`); alert('Applied & saved.'); }
      catch(e){ console.error(e); alert('Save failed. Check token/permissions.'); }
    };
    document.getElementById('undo').onclick= async ()=>{
      if(!selBill||!selPeople.size) return alert('Pick a bill and people.');
      undoInMemory(); updatePreview();
      try{ await commitOverrides(`admin: undo ${selBill.badge||'badge'} via ${selBill.bill_id} for ${selPeople.size} member(s)`); alert('Undone & saved.'); }
      catch(e){ console.error(e); alert('Save failed.'); }
    };

    load();
  </script>
</body>
</html>
