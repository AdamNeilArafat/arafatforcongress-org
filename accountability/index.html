<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Evergreen Reckoning — Awards • Wall • Countdowns</title>
  <meta name="description" content="Awards tied to specific bills, a filterable vote wall, and live countdowns. Hardened for static hosting."/>
  <meta name="theme-color" content="#0d3b66"/>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{ --primary:#0d3b66; --accent:#0b6e4f; --ink:#1b2634; --soft:#f6f9fc; }
    body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:#122; background:#fff; }
    header{ background:linear-gradient(180deg,#0d3b66 0%,#0b5aa1 100%); color:#fff; }
    .hero h1{ font-weight:800; letter-spacing:.2px; }
    .nav-tabs .nav-link{ font-weight:600; }
    .tab-pane{ padding-top:1rem; }
    .card-award{ border:1px solid #e6edf3; border-radius:16px; }
    .badge-soft{ background:#e6f2ea; color:#0b6e4f; }
    .chip{ display:flex; gap:.6rem; align-items:center; padding:.4rem .6rem; border:1px solid #e6edf3; border-radius:999px; background:#fff; }
    .chip img{ width:32px; height:39px; object-fit:cover; border-radius:6px; }
    .filters .form-select,.filters .form-control{ min-width:160px; }
    .wall-item{ border-bottom:1px solid #eef2f7; padding:12px 0; }
    .clock{ font-variant-numeric: tabular-nums; }
    .small-muted{ font-size:.875rem; color:#5b6b7b; }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <header class="py-4">
    <div class="container hero">
      <h1 class="h2 mb-1">Evergreen Reckoning</h1>
      <p class="mb-0">Awards tied to real bills. A live wall of votes. Countdowns that stay accurate.</p>
    </div>
  </header>

  <main class="container my-4">
    <!-- Tabs -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist" aria-label="Sections">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="awards-tab" data-bs-toggle="tab" data-bs-target="#awards" type="button" role="tab" aria-controls="awards" aria-selected="true">Awards</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="wall-tab" data-bs-toggle="tab" data-bs-target="#wall" type="button" role="tab" aria-controls="wall" aria-selected="false">Wall</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="countdowns-tab" data-bs-toggle="tab" data-bs-target="#countdowns" type="button" role="tab" aria-controls="countdowns" aria-selected="false">Countdowns</button>
      </li>
    </ul>

    <div class="tab-content" id="tabContent">
      <!-- AWARDS -->
      <section class="tab-pane fade show active" id="awards" role="tabpanel" aria-labelledby="awards-tab">
        <h2 class="h4 mt-3">Bill-linked Awards</h2>
        <div id="awardsWrap" class="row g-3"></div>
      </section>

      <!-- WALL -->
      <section class="tab-pane fade" id="wall" role="tabpanel" aria-labelledby="wall-tab">
        <h2 class="h4 mt-3">Vote Wall</h2>
        <div class="filters d-flex flex-wrap gap-2 align-items-end mb-3">
          <div>
            <label for="wfChamber" class="form-label">Chamber</label>
            <select id="wfChamber" class="form-select" aria-label="Filter by chamber">
              <option value="">All</option>
              <option value="house">House</option>
              <option value="senate">Senate</option>
            </select>
          </div>
          <div>
            <label for="wfParty" class="form-label">Party</label>
            <select id="wfParty" class="form-select" aria-label="Filter by party">
              <option value="">All</option>
              <option value="D">Democratic</option>
              <option value="R">Republican</option>
              <option value="I">Independent</option>
            </select>
          </div>
          <div>
            <label for="wfState" class="form-label">State</label>
            <input id="wfState" class="form-control" placeholder="WA, CA, TX…" aria-label="Filter by state"/>
          </div>
          <div class="flex-fill">
            <label for="wfSearch" class="form-label">Search</label>
            <input id="wfSearch" class="form-control" placeholder="Name, bill, keyword" aria-label="Search text"/>
          </div>
          <div>
            <label for="wfSort" class="form-label">Sort</label>
            <select id="wfSort" class="form-select" aria-label="Sort order">
              <option value="recent">Most recent</option>
              <option value="name">Name A→Z</option>
              <option value="state">State</option>
            </select>
          </div>
        </div>
        <div id="wallList"></div>
        <p id="wallEmpty" class="small-muted mt-3" hidden>No votes to display. Add <code>data/votes.json</code> or adjust your filters.</p>
      </section>

      <!-- COUNTDOWNS -->
      <section class="tab-pane fade" id="countdowns" role="tabpanel" aria-labelledby="countdowns-tab">
        <h2 class="h4 mt-3">Live Countdowns</h2>
        <div id="countWrap" class="row g-3"></div>
      </section>
    </div>
  </main>

  <footer class="container py-4 small-muted">
    <div>Local data paths used when available: <code>data/members.json</code>, <code>data/votes.json</code>. Remote fallbacks kick in automatically.</div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  // -----------------------------
  // 1) Hardened Bill Link Catalog
  // -----------------------------
  const BILLS = [
    { id:'grocery',  bill:'Fair Food and Grocery Competition Bill (2027)',          href:'../Bills/fair-food-and-grocery-competition-bill-2027.html',  award:'The Empty Fridge Award',       meaning:'They protected price-fixers, leaving families to choose between groceries or rent.' },
    { id:'childcare',bill:'Affordable Child and Dependent Care Bill (2027)',        href:'../Bills/affordable-child-and-dependent-care-bill-2027.html',award:'The Parent Punisher Award',     meaning:'They voted to keep childcare unaffordable and push parents out of work.' },
    { id:'jobs',     bill:'Good Jobs & Skills Bill (2027)',                         href:'../Bills/good-jobs-and-skills-bill-2027.html',               award:'The Paycheck Pickpocket Award',meaning:'They sided with corporate bosses to keep wages down and hours insecure.' },
    { id:'housing',  bill:'First-Time Homebuyer 3% Mortgage Bill (2027)',           href:'../Bills/first-time-homebuyer-3-percent-mortgage-bill-2027.html', award:'The Rent Raiser Award', meaning:'They blocked families from buying homes and left renters at the mercy of landlords.' },
    { id:'justify',  bill:'Congressional Vote Justification Bill (2027)',           href:'../Bills/congressional-vote-justification-bill-2027.html',   award:'The Coward’s Mask Award',      meaning:'They voted against explaining themselves, hiding their real loyalties.' }
  ];

  // ------------------------------------
  // 2) TZ-safe day counter for countdowns
  // ------------------------------------
  function parseYMDLocal(s){
    // "YYYY-MM-DD" → local noon to avoid DST/UTC midnight drift
    const [y,m,d] = s.split('-').map(Number);
    return new Date(y, m-1, d, 12, 0, 0, 0);
  }
  function updateClocks(){
    document.querySelectorAll('.clock-days[data-date]').forEach(el=>{
      const s = (el.dataset.date||'').trim();
      if(!/^\d{4}-\d{2}-\d{2}$/.test(s)){ el.textContent='—'; return; }
      const d = parseYMDLocal(s);
      const days = Math.max(0, Math.floor((Date.now() - d.getTime())/86400000));
      el.textContent = `${days} days`;
    });
  }

  // ------------------------------------
  // 3) Faster, resilient member directory
  // ------------------------------------
  async function loadMembers(){
    const local = await fetch('data/members.json', {cache:'no-store'}).then(r=>r.ok?r.json():null).catch(()=>null);
    const raw = local || await fetch('https://raw.githubusercontent.com/unitedstates/congress-legislators/refs/heads/gh-pages/legislators-current.json',{cache:'no-store'}).then(r=>r.json());
    const byBio = {};
    for (const m of raw){
      const bioguide = m.id?.bioguide || m.bioguide;
      if(!bioguide) continue;
      const t = (m.terms||[]).slice(-1)[0] || m.term || {};
      const first = m.name?.first || m.first_name || '';
      const last  = m.name?.last  || m.last_name  || '';
      const chamber = (t.type==='sen' || m.chamber==='senate') ? 'senate' : 'house';
      const state = t.state || m.state || '';
      const district = (chamber==='house') ? (t.district||m.district||'') : '';
      const party = (t.party || m.party || '').toUpperCase();
      byBio[bioguide] = {
        bioguide, first, last,
        name: `${first} ${last}`.trim(),
        party, chamber, state, district,
        photo: `https://unitedstates.github.io/images/congress/225x275/${bioguide}.jpg`
      };
    }
    return byBio;
  }
  const chip = m => `
    <div class="chip">
      <img src="${m.photo}" alt="${m.name}" loading="lazy"
           onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2256%22 height=%2268%22><rect width=%2256%22 height=%2268%22 fill=%22%23e6edf3%22/><text x=%2250%25%22 y=%2255%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2210%22 fill=%22%23666%22>NO IMG</text></svg>'"/>
      <div>
        <div class="fw-semibold">${m.name}</div>
        <div class="small text-muted">${m.chamber==='house'?`${m.state}-${m.district}`:m.state} • ${m.party}</div>
      </div>
    </div>`;

  // -----------------------------
  // 4) Safe votes.json loader
  // -----------------------------
  async function safeLoadVotes(){
    try{
      const r = await fetch('data/votes.json',{cache:'no-store'});
      if(!r.ok) throw 0;
      return await r.json();
    }catch{
      console.warn('votes.json not found; rendering empty state');
      return [];
    }
  }

  // -----------------------------
  // 5) Debounce utility
  // -----------------------------
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  // -----------------------------
  // 6) Render: Awards
  // -----------------------------
  function renderAwards(){
    const wrap = document.getElementById('awardsWrap');
    wrap.innerHTML = BILLS.map(b => `
      <div class="col-12 col-md-6 col-lg-4" id="award-${b.id}">
        <div class="card card-award h-100">
          <div class="card-body d-flex flex-column">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <span class="badge badge-soft">${b.award}</span>
              <i class="fa-solid fa-trophy ms-2"></i>
            </div>
            <h3 class="h6 mb-2">${b.bill}</h3>
            <p class="mb-3 small">${b.meaning}</p>
            <div class="mt-auto d-flex gap-2">
              <a class="btn btn-outline-primary btn-sm" href="${encodeURI(b.href)}" target="_blank" rel="noopener noreferrer">Open blueprint</a>
              <a class="btn btn-outline-secondary btn-sm" href="#awards?bill=${encodeURIComponent(b.id)}">Link to award</a>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }

  // -----------------------------
  // 7) Render: Wall
  // -----------------------------
  function normalizeState(s){ return (s||'').toUpperCase().slice(0,2); }

  function renderWall(){
    const list = document.getElementById('wallList');
    const empty = document.getElementById('wallEmpty');
    if(!window.__votes || !window.__members){ list.innerHTML=''; empty.hidden=false; return; }

    const chamber = document.getElementById('wfChamber').value;
    const party   = document.getElementById('wfParty').value.toUpperCase();
    const state   = normalizeState(document.getElementById('wfState').value);
    const q       = (document.getElementById('wfSearch').value||'').toLowerCase();
    const sort    = document.getElementById('wfSort').value;

    let rows = window.__votes.map(v => {
      // Expected minimal structure: { bioguide, billId, position, ts }
      const m = window.__members[v.bioguide] || {};
      const bill = BILLS.find(b=>b.id===v.billId) || {};
      return {
        ...v,
        member: m,
        billTitle: bill.bill || v.billTitle || v.billId,
        billHref: bill.href || '#',
        name: m.name || v.name || '',
        party: m.party || '',
        state: m.state || '',
        chamber: m.chamber || v.chamber || '',
      };
    });

    // Filters
    rows = rows.filter(r =>
      (!chamber || r.chamber===chamber) &&
      (!party || r.party===party) &&
      (!state || normalizeState(r.state)===state) &&
      (!q || (r.name.toLowerCase().includes(q) || (r.billTitle||'').toLowerCase().includes(q)))
    );

    // Sort
    if(sort==='name') rows.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    else if(sort==='state') rows.sort((a,b)=> (a.state||'').localeCompare(b.state||''));
    else rows.sort((a,b)=> (b.ts||0) - (a.ts||0)); // recent

    // Render
    list.innerHTML = rows.map(r=>`
      <div class="wall-item">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div class="d-flex gap-2 align-items-center">
            ${chip(r.member || {})}
            <span class="badge ${r.position==='No'?'text-bg-danger':'text-bg-success'}">${r.position||'—'}</span>
          </div>
          <div class="text-end small">
            <div class="small-muted">${r.state||''}${r.chamber?` • ${r.chamber}`:''}${r.party?` • ${r.party}`:''}</div>
            <div class="small-muted">${r.ts ? new Date(r.ts).toLocaleString() : ''}</div>
          </div>
        </div>
        <div class="mt-2">
          <a href="${encodeURI(r.billHref)}" target="_blank" rel="noopener noreferrer" class="fw-semibold">${r.billTitle}</a>
        </div>
      </div>
    `).join('');

    empty.hidden = rows.length>0;
  }

  // -----------------------------
  // 8) Render: Countdowns
  // -----------------------------
  const COUNT_ITEMS = [
    // Edit dates as needed (YYYY-MM-DD). Counters stay correct in local TZ.
    { id:'next-session', label:'Days since 119th Congress began', date:'2025-01-03' },
    { id:'last-election', label:'Days since General Election',    date:'2024-11-05' }
  ];
  function renderCountdowns(){
    const wrap = document.getElementById('countWrap');
    wrap.innerHTML = COUNT_ITEMS.map(c => `
      <div class="col-12 col-md-6 col-lg-4" id="tab-${c.id}">
        <div class="card h-100">
          <div class="card-body">
            <div class="small-muted mb-1">${c.label}</div>
            <div class="h3 clock clock-days" data-date="${c.date}">—</div>
            <div class="small text-muted">from ${c.date}</div>
          </div>
        </div>
      </div>
    `).join('');
    updateClocks();
  }

  // -----------------------------
  // 9) Deep-link routing to tabs/awards
  // -----------------------------
  function handleHash(){
    const [hash, qs] = location.hash.split('?');
    if(!hash) return;
    const open = sel => { const el=document.querySelector(sel); if(el) new bootstrap.Tab(el).show(); };

    if(hash==='#wall') open('[data-bs-target="#wall"]');
    if(hash==='#countdowns') open('[data-bs-target="#countdowns"]');
    if(hash==='#awards') open('[data-bs-target="#awards"]');

    const params = new URLSearchParams(qs||'');
    const bill = params.get('bill');
    if(bill){
      const target = document.getElementById(`award-${bill}`) || document.getElementById(`tab-${bill}`);
      if(target) target.scrollIntoView({behavior:'smooth', block:'start'});
    }
  }

  // -----------------------------
  // 10) Init
  // -----------------------------
  async function init(){
    // Render static sections first
    renderAwards();
    renderCountdowns();
    updateClocks();
    setInterval(updateClocks, 60000);

    // Data loads
    const [members, votes] = await Promise.all([loadMembers(), safeLoadVotes()]);
    window.__members = members;
    window.__votes = Array.isArray(votes) ? votes : [];

    // Wire filters (with debounce on search)
    ['wfChamber','wfParty','wfState','wfSort'].forEach(id=>{
      document.getElementById(id).addEventListener('input', renderWall);
      document.getElementById(id).addEventListener('change', renderWall);
    });
    document.getElementById('wfSearch').addEventListener('input', debounce(renderWall, 180));

    renderWall();
    handleHash();
    window.addEventListener('hashchange', handleHash);
  }

  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
