<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Wall of Shame â€” Faces, Votes, Receipts | Adam Neil Arafat for Congress</title>
  <meta name="description" content="Faces, votes, and receipts. Filter by bill, state, or party. Click any face for the proof and a shareable receipt."/>
  <meta name="theme-color" content="#0d3b66"/>

  <!-- Open Graph -->
  <meta property="og:title" content="Wall of Shame â€” Faces, Votes, Receipts"/>
  <meta property="og:description" content="Filter by bill, state, or party. Every face has a receipt you can share."/>
  <meta property="og:type" content="website"/>
  <meta property="og:image" content="assets/share-wall.png"/>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{
      --ink:#122133; --muted:#5b6b7c; --soft:#f6f9fc; --danger:#c1121f; --ok:#0b6e4f; --brand:#0d3b66;
      --card:#fff; --ring:rgba(13,59,102,.12); --ring-strong:rgba(13,59,102,.22);
      --good:#0b6e4f; --bad:#b42318; --info:#0d3b66;
    }
    html,body{background:var(--soft); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--brand); text-decoration:none} a:hover{text-decoration:underline}
    .navbar .nav-link{position:relative; padding:.25rem .5rem; font-weight:600; color:#1b2a3a}
    .navbar .nav-link::after{content:""; position:absolute; left:0; bottom:-4px; height:2px; width:0; background:currentColor; border-radius:2px; transition:width .18s}
    .navbar .nav-link:hover::after,.navbar .nav-link.active::after{width:100%}

    .hero{background:linear-gradient(180deg,#0d3b66,#0b3157); color:#fff; padding:2.5rem 0}
    .hero h1{font-weight:900; letter-spacing:.2px}
    .hero p.lead{opacity:.95}

    .tools{display:flex; gap:.5rem; flex-wrap:wrap; align-items:center}
    .search{max-width:380px}

    .card-person{position:relative; background:var(--card); border:1px solid var(--ring); border-radius:14px; overflow:hidden; transition:box-shadow .16s, transform .16s, border-color .16s}
    .card-person:hover{box-shadow:0 14px 40px rgba(13,59,102,.16); border-color:var(--ring-strong); transform:translateY(-2px)}
    .card-person .body{padding:.75rem .9rem}
    .name{font-weight:800}
    .meta{color:var(--muted); font-size:.9rem}

    /* micro finance strip */
    .fin-mini{font-size:.76rem; color:#334155; background:#f1f5f9; padding:.35rem .55rem; border-top:1px dashed #e2e8f0}
    .fin-mini .dot{display:inline-block; width:.38rem; height:.38rem; border-radius:999px; margin-right:.35rem; vertical-align:middle; background:#94a3b8}
    .fin-mini strong{font-weight:800}

    .chip{font-size:.7rem; font-weight:800; border-radius:999px; padding:.2rem .5rem; display:inline-block}
    .chip.bad{background:#ffecec; color:var(--bad)}
    .chip.good{background:#e8f7ef; color:var(--good)}
    .chip.info{background:#eef6ff; color:var(--info)}
    .chip.no{background:#ffecec; color:#b42318; margin-left:.25rem}

    .harm{margin:.4rem 0 .6rem; color:#334155; font-size:.92rem}

    .grid{display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:.8rem}
    @media (min-width:576px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media (min-width:992px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr));} }
    @media (min-width:1200px){ .grid{grid-template-columns:repeat(4,minmax(0,1fr));} }

    .skeleton{background:linear-gradient(90deg,#eceff3 25%,#f5f7fa 37%,#eceff3 63%); background-size:400% 100%; animation:sheen 1.2s infinite; border-radius:12px; height:300px}
    @keyframes sheen{0%{background-position:100% 0} 100%{background-position:0 0}}

    /* Thumbnail faces */
    .avatar{
      width:100%; height:auto; aspect-ratio:4/3; object-fit:cover; background:#e6edf3; display:block;
      /* speed hints */
      loading:lazy; /* HTML attr also set inline for safety */
    }

    .btn-icon i{margin-right:.5rem}

    .modal .award{font-weight:900; color:#8f0d16}
    .modal .muted{color:#475569}
    footer{background:#0d3b66; color:#fff; padding:1.25rem 0; margin-top:2rem}
  </style>
</head>
<body>

<!-- NAV -->
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top" aria-label="Main">
  <div class="container">
    <a class="navbar-brand fw-bold" href="./index.html">Adam Neil Arafat for Congress - WA-10</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav ms-auto align-items-lg-center">
        <li class="nav-item"><a class="nav-link active" href="./index.html" aria-current="page">Wall of Shame</a></li>
        <li class="nav-item"><a class="nav-link" href="./financial-alignments.html">Financial Alignments</a></li>
        <li class="nav-item"><a class="nav-link" href="./badges.html">Badges &amp; Awards</a></li>
        <li class="nav-item"><a class="nav-link" href="./digging-into-the-issues.html">Issues</a></li>
        <li class="nav-item"><a class="nav-link" href="./contrast.html">Record &amp; Contrast</a></li>
        <li class="nav-item"><a class="nav-link" href="./contact.html">Contact</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- HERO -->
<header class="hero">
  <div class="container text-center">
    <h1 class="mb-2">Wall of Shame</h1>
    <p class="lead mb-3">See the faces. Check the votes. Open the receipts.</p>
    <div class="tools justify-content-center">
      <div class="input-group input-group-sm search">
        <span class="input-group-text" id="basic-addon1" aria-hidden="true"><i class="fa-solid fa-magnifying-glass"></i></span>
        <input type="search" id="wfSearch" class="form-control" placeholder="Search name, state, billâ€¦" aria-label="Search wall"/>
      </div>
      <select id="wfBill" class="form-select form-select-sm" aria-label="Filter by bill"></select>
      <select id="wfState" class="form-select form-select-sm" aria-label="Filter by state"></select>
      <select id="wfParty" class="form-select form-select-sm" aria-label="Filter by party">
        <option value="">All parties</option>
        <option value="D">Democrat</option>
        <option value="R">Republican</option>
        <option value="I">Independent</option>
      </select>
      <button id="resetFilters" class="btn btn-outline-secondary btn-sm">Reset</button>

      <!-- Hero quick jumps -->
      <a href="#plan" class="btn btn-outline-light btn-sm">View the plan</a>
      <a href="#grid" class="btn btn-outline-secondary btn-sm">Skip to the Wall</a>
    </div>
  </div>
</header>

<!-- PLAN (Unified Plan Section) -->
<section id="plan" class="container my-4">
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h2 class="h4 mb-0">Accountability Plan â€” Atâ€‘aâ€‘Glance</h2>
        <a class="btn btn-outline-secondary btn-sm" href="#grid">Skip to the Wall</a>
      </div>
      <p class="text-muted mt-2 mb-3">
        Clear, visual accountability backed by public data. Each Member can earn multiple badges tied to donations and votes. Click any face to see the receipts.
      </p>

      <div class="accordion" id="planAcc">
        <!-- Main Building Blocks (tightened) -->
        <div class="accordion-item">
          <h3 class="accordion-header" id="p-blocks-h">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#p-blocks" aria-expanded="true" aria-controls="p-blocks">
              ðŸ§± Main Building Blocks
            </button>
          </h3>
          <div id="p-blocks" class="accordion-collapse collapse show" aria-labelledby="p-blocks-h" data-bs-parent="#planAcc">
            <div class="accordion-body">
              <ol class="mb-0">
                <li><strong>Wall:</strong> all 535 faces with quick stats and badges.</li>
                <li><strong>Badges:</strong> autoâ€‘assigned from FEC totals, donor mix, and (optionally) vote alignment.</li>
                <li><strong>Receipts:</strong> billâ€‘byâ€‘bill evidence with a shareable link.</li>
                <li><strong>Financial Alignments:</strong> charts for PAC vs small donors, local vs outâ€‘ofâ€‘district, and top industries.</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Deployment Strategy -->
        <div class="accordion-item">
          <h3 class="accordion-header" id="p-deploy-h">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#p-deploy" aria-expanded="false" aria-controls="p-deploy">
              ðŸš€ Deployment Strategy
            </button>
          </h3>
          <div id="p-deploy" class="accordion-collapse collapse" aria-labelledby="p-deploy-h" data-bs-parent="#planAcc">
            <div class="accordion-body">
              <ol class="mb-0">
                <li><strong>Phase 1:</strong> Static wall + badge gallery.</li>
                <li><strong>Phase 2:</strong> FEC data â†’ analysis â†’ badges.</li>
                <li><strong>Phase 3:</strong> Profiles with charts/tables.</li>
                <li><strong>Phase 4:</strong> Social share packs (badge + face).</li>
              </ol>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <a class="btn btn-danger btn-sm" href="#grid"><i class="fa-solid fa-fire-flame-curved me-1"></i>See the Wall</a>
        <a class="btn btn-outline-dark btn-sm" href="./financial-alignments.html"><i class="fa-solid fa-chart-pie me-1"></i>Financial Alignments Page</a>
        <a class="btn btn-outline-dark btn-sm" href="./badges.html"><i class="fa-solid fa-award me-1"></i>Badges &amp; Awards</a>
      </div>
    </div>
  </div>
</section>

<!-- GRID -->
<main class="container my-4">
  <div id="grid" class="grid" aria-live="polite" aria-busy="true">
    <!-- skeletons -->
    <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
    <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
  </div>
  <p id="emptyState" class="text-center text-muted mt-3" hidden>No matches. Try clearing filters.</p>
</main>

<!-- RECEIPT MODAL -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="receiptTitle">Receipt</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex gap-3 align-items-start">
          <img id="receiptPhoto" src="" alt="" class="rounded" width="120" height="150" loading="lazy" decoding="async" fetchpriority="low"/>
          <div>
            <div class="name h4 mb-0" id="receiptName"></div>
            <div class="meta" id="receiptMeta"></div>
            <div class="award mt-2" id="receiptAward"></div>
            <div class="harm mt-2 mb-2" id="receiptHarm"></div>
            <div class="small muted"><span class="fw-semibold">Bill:</span> <a id="receiptBill" href="#" target="_blank" rel="noopener"></a></div>
          </div>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        <div class="d-flex gap-2">
          <button id="shareBtn" class="btn btn-outline-dark btn-sm btn-icon" type="button"><i class="fa-solid fa-share-nodes"></i>Share</button>
          <a id="openBlueprint" class="btn btn-danger btn-sm btn-icon" href="#" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines"></i>Open blueprint</a>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container text-center small">
    <p class="mb-1">Paid for by Adam Neil Arafat for Congress</p>
    <p class="mb-0">&copy; 2025 Adam Neil Arafat. All Rights Reserved.</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
<script>
/** ---------------------------------------------------------
 *  DATA LOADERS + HELPERS
 *  --------------------------------------------------------- */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

function normalizeParty(p){
  const s = (p||'').trim().toUpperCase();
  if (s.startsWith('D')) return 'D';
  if (s.startsWith('R')) return 'R';
  if (s.startsWith('I')) return 'I';
  return '';
}
function partyLabel(code){
  return code==='D' ? 'Democrat'
       : code==='R' ? 'Republican'
       : code==='I' ? 'Independent'
       : '';
}

async function loadMembers(){
  // 1) local mirror (fast, versioned)
  try{
    const r = await fetch('data/members.json', {cache:'no-store'});
    if(r.ok){
      const local = await r.json();
      const norm = {};
      for(const m of local){
        const bioguide = m.bioguide || m.id?.bioguide;
        if(!bioguide) continue;
        const pCode = normalizeParty(m.party || '');
        norm[bioguide] = {
          bioguide,
          name: m.name || `${m.first||m.name_first||''} ${m.last||m.name_last||''}`.trim(),
          partyCode: pCode,
          partyLabel: partyLabel(pCode),
          chamber: m.chamber || '',
          state: m.state || '',
          district: m.district || '',
          photo: m.photo || `https://unitedstates.github.io/images/congress/225x275/${bioguide}.jpg`,
          sizes: '(max-width:576px) 100vw, 25vw'
        };
      }
      return norm;
    }
  }catch(e){ /* ignore */ }

  // 2) live fallback (GitHub-hosted JSON)
  const url = 'https://raw.githubusercontent.com/unitedstates/congress-legislators/gh-pages/legislators-current.json';
  const raw = await fetch(url, {cache:'no-store'}).then(r=>r.json());
  const byBio = {};
  for(const m of raw){
    const bioguide = m.id?.bioguide; if(!bioguide) continue;
    const t = (m.terms||[]).slice(-1)[0] || {};
    const pCode = normalizeParty(t.party || '');
    byBio[bioguide] = {
      bioguide,
      name: `${m.name?.first||''} ${m.name?.last||''}`.trim(),
      partyCode: pCode,
      partyLabel: partyLabel(pCode),
      chamber: (t.type==='sen')?'senate':'house',
      state: t.state || '',
      district: (t.type==='rep') ? (t.district||'') : '',
      photo: `https://unitedstates.github.io/images/congress/225x275/${bioguide}.jpg`,
      sizes: '(max-width:576px) 100vw, 25vw'
    };
  }
  return byBio;
}

/* Minimal financials for badges + mini strip
   Expected shape (example):
   {
     "A000360": {
        "pac_total": 125000,
        "small_pct": 18,
        "local_pct": 22,
        "industries": {"defense":52000,"pharma":15000,"finance":9000,"aipac":23000},
        "top_pac": {"name":"Example PAC","amount":55000}
     }
   }
*/
async function loadFinancials(){
  try{
    const r = await fetch('data/financials.json', {cache:'no-store'});
    if(!r.ok) throw new Error('no financials');
    return await r.json();
  }catch(e){
    console.warn('financials.json not found; skipping finance badges');
    return {};
  }
}

/* Bill receipts (whoâ€™s an offender per bill) */
async function loadVotes(){
  try{
    const r = await fetch('data/votes.json', {cache:'no-store'});
    if(!r.ok) throw new Error('no votes file');
    return await r.json();
  }catch(e){
    console.warn('votes.json not found; rendering neutral wall');
    return {};
  }
}

/* Optional vote records (member -> list of {bill, position}) */
async function loadVoteRecords(){
  try{
    const r = await fetch('data/vote_records.json', {cache:'no-store'});
    if(!r.ok) throw new Error('no vote records');
    return await r.json();
  }catch(e){
    return {};
  }
}

/* Optional bill tags (billKey -> ["defense","pharma",...]) */
async function loadBillTags(){
  try{
    const r = await fetch('data/bill_tags.json', {cache:'no-store'});
    if(!r.ok) throw new Error('no bill tags');
    return await r.json();
  }catch(e){
    return {};
  }
}

/** ---------------------------------------------------------
 *  BADGE RULES (good + bad)  â€” now with donor-alignment
 *  --------------------------------------------------------- */

/* optional synonym expansion so your tags can be flexible */
const industryKeyAliases = {
  defense: ['defense','military','security'],
  pharma: ['pharma','drug','biotech','healthcare'],
  energy: ['energy','oil','gas','utilities'],
  finance:['finance','bank','wallstreet','securities','insurance'],
  aipac:  ['aipac','israel','foreignpolicy','foreign-policy'],
  labor:  ['labor','unions'],
  tech:   ['tech','technology']
};

function expandKeys(keys){
  const set = new Set();
  for(const k of keys||[]){
    set.add(k);
    for(const [root, arr] of Object.entries(industryKeyAliases)){
      if (k===root || (arr||[]).includes(k)) { set.add(root); arr.forEach(x=>set.add(x)); }
    }
  }
  return set;
}

function topIndustryKey(finInfo){
  if(!finInfo || !finInfo.industries) return null;
  const entries = Object.entries(finInfo.industries);
  if(!entries.length) return null;
  entries.sort((a,b)=> Number(b[1]||0) - Number(a[1]||0));
  return entries[0][0]; // key only
}

function isOffenderForBill(billKey, bio){
  const b = VOTES[billKey];
  if(!b) return false;
  const offenders = b.offenders || [];
  return offenders.some(row => row.bioguide === bio);
}

function donorAlignmentBadges(bio, finInfo){
  // Requires both bill tags and vote records
  if(!finInfo) return [];
  const topKey = topIndustryKey(finInfo);
  if(!topKey) return [];

  const tagsForBills = BILL_TAGS || {};
  const memberVotes = VOTE_RECORDS[bio] || []; // [{bill, position}, ...]

  // Expand both sides for tolerant matching
  const topKeyExpanded = expandKeys([topKey]);

  for(const rec of memberVotes){
    const tags = tagsForBills[rec.bill];
    if(!tags || !tags.length) continue;

    const billTagsExpanded = expandKeys(tags);
    // overlap?
    let overlaps = false;
    for(const k of topKeyExpanded) if(billTagsExpanded.has(k)) { overlaps = true; break; }
    if(!overlaps) continue;

    if (isOffenderForBill(rec.bill, bio)) {
      return [{kind:'bad', label:'Donorâ€‘Aligned Vote'}];
    } else {
      // not listed as offender; give positive credit for breaking with funders
      return [{kind:'good', label:'Broke with Donors'}];
    }
  }
  return [];
}

function assignBadges(finInfo, voteInfoForMember, bio){
  const out = [];
  if(!finInfo) return out;

  const pac = Number(finInfo.pac_total||0);
  const small = Number(finInfo.small_pct||0);
  const local = Number(finInfo.local_pct||0);
  const ind = finInfo.industries||{};
  const topInd = Object.entries(ind).sort((a,b)=>b[1]-a[1])[0];

  // Bad badges
  if(pac >= 100000) out.push({kind:'bad', label:'Bought & Paid'});
  if(local < 50 && pac >= 20000) out.push({kind:'bad', label:'Backstabber'});
  if(topInd && topInd[1] >= 20000){
    const name = (topInd[0]||'').toUpperCase();
    out.push({kind:'bad', label:`Leash: ${name}`});
  }
  if((ind.aipac||0) + (ind.defense||0) >= 50000) out.push({kind:'bad', label:'Blood Money'});

  // Good badges
  if(small >= 60) out.push({kind:'good', label:'Grassrootsâ€‘Funded'});
  if(local >= 60) out.push({kind:'good', label:'Hometownâ€‘Funded'});

  // Donor alignment (new)
  out.push(...donorAlignmentBadges(bio, finInfo));

  return out;
}

function miniFinance(finInfo){
  if(!finInfo) return '';
  const fmt = n => (n==null?'â€“':(typeof n==='number'?n: Number(n))).toLocaleString();
  const pac = finInfo.pac_total!=null ? `$${fmt(Math.round(finInfo.pac_total))}` : 'â€“';
  const small = finInfo.small_pct!=null ? `${fmt(Math.round(finInfo.small_pct))}%` : 'â€“';
  const local = finInfo.local_pct!=null ? `${fmt(Math.round(finInfo.local_pct))}%` : 'â€“';
  return `
    <div class="fin-mini" title="Quick donor mix: PAC total â€¢ % small donors â€¢ % in-district">
      <span class="dot"></span><strong>PAC:</strong> ${pac}
      &nbsp;â€¢&nbsp; <strong>Small:</strong> ${small}
      &nbsp;â€¢&nbsp; <strong>Local:</strong> ${local}
    </div>
  `;
}

/** ---------------------------------------------------------
 *  RENDERING
 *  --------------------------------------------------------- */
const grid = document.getElementById('grid');
const emptyState = document.getElementById('emptyState');
const wfSearch = document.getElementById('wfSearch');
const wfBill   = document.getElementById('wfBill');
const wfState  = document.getElementById('wfState');
const wfParty  = document.getElementById('wfParty');

let MEMBERS = {};
let VOTES = {};
let FIN = {};
let VOTE_RECORDS = {};
let BILL_TAGS = {};
let INDEX = []; // rows to render (neutral + offenders)

function buildFilters(){
  // Bills
  const billOptions = ['<option value="">All bills</option>'];
  Object.entries(VOTES).forEach(([key, b])=>{
    billOptions.push(`<option value="${key}">${b.title}</option>`);
  });
  wfBill.innerHTML = billOptions.join('');

  // States (from everyone)
  const states = new Set();
  Object.values(MEMBERS).forEach(m=>{ if(m.state) states.add(m.state); });
  const stateList = Array.from(states).sort();
  wfState.innerHTML = ['<option value="">All states</option>', ...stateList.map(s=>`<option value="${s}">${s}</option>`)].join('');
}

function badgeChips(badges){
  if(!badges || !badges.length) return '';
  return `
    <div class="d-flex align-items-center gap-2 flex-wrap mt-1">
      ${badges.slice(0,3).map(b => `<span class="chip ${b.kind==='good'?'good':'bad'}" title="${b.label}">${b.label}</span>`).join('')}
      ${badges.length>3 ? `<span class="chip info">+${badges.length-3}</span>` : ``}
    </div>
  `;
}

function cardHTML(o){
  const isOffender = !!o.billKey;
  const harm  = isOffender ? (o.meaning || '') : '';
  const encodedHref = isOffender ? encodeURI(o.href||'#') : '#';

  const imgAttrs = `class="avatar" src="${o.photo}"
    alt="${o.name}" loading="lazy" decoding="async" fetchpriority="low"
    referrerpolicy="no-referrer" sizes="${o.sizes||'(max-width:576px) 100vw, 25vw'}"`;

  return `
  <article class="card-person"
           data-bill="${o.billKey||''}"
           data-party="${o.partyCode||''}"
           data-state="${o.state}"
           data-name="${o.name.toLowerCase()}">
    <img ${imgAttrs}
         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22225%22><rect width=%22300%22 height=%22225%22 fill=%22%23e6edf3%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2214%22 fill=%22%23666%22>NO IMAGE</text></svg>'"/>
    ${o.finMini||''}
    <div class="body">
      <div class="name">${o.name}</div>
      <div class="meta">${o.chamber==='senate'?'Senate':'House'} â€¢ ${o.state}${o.district?('-'+o.district):''} â€¢ ${o.partyLabel||''}</div>
      ${o.badgeHTML||''}
      ${isOffender && harm ? `<div class="harm">${harm}</div>` : ``}
      ${isOffender ? `
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="chip info">Bill: ${o.billShort}</span><span class="chip bad">${o.vote||'NO'} vote</span>
        </div>` : ``}
      <div class="mt-2 d-flex gap-2">
        ${isOffender ? `
          <button class="btn btn-outline-dark btn-sm btn-icon" type="button"
                  data-open-receipt='${JSON.stringify({bio:o.bioguide,bill:o.billKey}).replace(/"/g,"&quot;")}'><i class="fa-solid fa-receipt"></i>View receipt</button>
          <a class="btn btn-danger btn-sm btn-icon" href="${encodedHref}" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines"></i>Open blueprint</a>
        ` : `
          <button class="btn btn-outline-secondary btn-sm" type="button" disabled title="No receipt for this Member">No receipt</button>
        `}
      </div>
    </div>
  </article>`;
}

/**
 * Build INDEX:
 *  1) Neutral row for every Member (with finance mini + auto badges)
 *  2) Offender row for each offender in votes
 */
function joinData(){
  INDEX = [];

  // Everyone (neutral)
  for(const m of Object.values(MEMBERS)){
    const fin = FIN[m.bioguide];
    const voteInfo = VOTE_RECORDS[m.bioguide];
    const badges = assignBadges(fin, voteInfo, m.bioguide);
    INDEX.push({
      billKey:'', billTitle:'', billShort:'', href:'', award:'', meaning:'', vote:'',
      bioguide:m.bioguide, name:m.name,
      partyCode:m.partyCode, partyLabel:m.partyLabel,
      chamber:m.chamber, state:m.state, district:m.district, photo:m.photo, sizes:m.sizes,
      finMini: miniFinance(fin),
      badgeHTML: badgeChips(badges)
    });
  }

  // Offenders
  for(const [billKey, b] of Object.entries(VOTES)){
    const offenders = b.offenders || [];
    for(const row of offenders){
      const m = MEMBERS[row.bioguide];
      if(!m) continue;
      const fin = FIN[m.bioguide];
      const voteInfo = VOTE_RECORDS[m.bioguide];
      const badges = assignBadges(fin, voteInfo, m.bioguide);
      INDEX.push({
        billKey,
        billTitle:b.title,
        billShort:(b.short||b.title),
        href:b.href,
        award:b.award,
        meaning:b.meaning,
        vote:row.vote || 'NO',
        bioguide:m.bioguide, name:m.name,
        partyCode:m.partyCode, partyLabel:m.partyLabel,
        chamber:m.chamber, state:m.state, district:m.district, photo:m.photo, sizes:m.sizes,
        finMini: miniFinance(fin),
        badgeHTML: badgeChips(badges)
      });
    }
  }

  // Offenders first, then Aâ†’Z by name
  INDEX.sort((a,b)=> ((b.billKey?1:0) - (a.billKey?1:0)) || a.name.localeCompare(b.name));
}

function render(){
  grid.setAttribute('aria-busy','true');

  // filters
  const q = wfSearch.value.trim().toLowerCase();
  const bill = wfBill.value;
  const party = wfParty.value; // '', 'D', 'R', 'I'
  const state = wfState.value;

  const pass = INDEX.filter(o=>{
    if(bill){
      if(o.billKey !== bill) return false;
    }
    if(party && o.partyCode !== party) return false;
    if(state && o.state!==state) return false;
    if(q){
      const hay = `${o.name} ${o.state}-${o.district} ${o.partyLabel} ${o.billTitle} ${o.award} ${o.meaning}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  if(pass.length===0){
    grid.innerHTML = '';
    emptyState.hidden = false;
  }else{
    emptyState.hidden = true;
    grid.innerHTML = pass.map(cardHTML).join('');
  }
  grid.removeAttribute('aria-busy');
}

function openReceipt(bio, billKey){
  const b = VOTES[billKey];
  const m = MEMBERS[bio];
  if(!b || !m) return;

  const encodedHref = encodeURI(b.href||'#');

  document.getElementById('receiptTitle').textContent = 'Receipt';
  const img = document.getElementById('receiptPhoto');
  img.src = m.photo; img.alt = m.name;

  document.getElementById('receiptName').textContent = m.name;
  document.getElementById('receiptMeta').textContent =
    `${m.chamber==='senate'?'Senate':'House'} â€¢ ${m.state}${m.district?('-'+m.district):''} â€¢ ${m.partyLabel||''}`;
  document.getElementById('receiptAward').textContent = b.award || '';
  document.getElementById('receiptHarm').textContent  = b.meaning || '';
  const billLink = document.getElementById('receiptBill');
  billLink.textContent = b.title || '';
  billLink.href = encodedHref;

  const openBtn = document.getElementById('openBlueprint');
  openBtn.href = encodedHref;

  const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
  modal.show();

  // share handler
  const url = new URL(location.href);
  url.hash = ''; url.search = ''; url.pathname = location.pathname;
  const deeplink = `/#?bill=${encodeURIComponent(billKey)}&bio=${encodeURIComponent(bio)}`;
  const shareBtn = document.getElementById('shareBtn');
  shareBtn.onclick = async () => {
    const shareUrl = url.origin + url.pathname + deeplink;
    try{
      if(navigator.share){
        await navigator.share({title:'Wall of Shame â€” Receipt', text:`${m.name} â€” ${b.award||'Receipt'}`, url: shareUrl});
      }else{
        await navigator.clipboard.writeText(shareUrl);
        shareBtn.textContent = 'Link copied';
        setTimeout(()=> shareBtn.innerHTML = '<i class="fa-solid fa-share-nodes"></i>Share', 1200);
      }
    }catch(e){}
  };
}

function handleDeepLink(){
  const [hash, qs] = location.hash.split('?');
  if(qs){
    const p = new URLSearchParams(qs);
    const bill = p.get('bill'); const bio = p.get('bio');
    if(bill){ wfBill.value = bill; }
    render();
    if(bill && bio){
      setTimeout(()=> openReceipt(bio, bill), 50);
    }
  }
}

/** ---------------------------------------------------------
 *  EVENTS
 *  --------------------------------------------------------- */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-open-receipt]');
  if(!btn) return;
  try{
    const data = JSON.parse(btn.getAttribute('data-open-receipt'));
    openReceipt(data.bio, data.bill);
  }catch(e){}
});

const rerender = debounce(render, 160);
wfSearch.addEventListener('input', rerender);
[wfBill, wfState, wfParty].forEach(el => el.addEventListener('change', render));
document.getElementById('resetFilters').addEventListener('click', ()=>{
  wfSearch.value=''; wfBill.value=''; wfState.value=''; wfParty.value='';
  render();
});

/** ---------------------------------------------------------
 *  BOOT
 *  --------------------------------------------------------- */
(async function init(){
  const [members, votes, financials, voteRecs, billTags] = await Promise.all([
    loadMembers(), loadVotes(), loadFinancials(), loadVoteRecords(), loadBillTags()
  ]);
  MEMBERS = members;
  VOTES   = votes;
  FIN     = financials;
  VOTE_RECORDS = voteRecs;
  BILL_TAGS = billTags;

  buildFilters();
  joinData();
  render();
  handleDeepLink();
})();
</script>
